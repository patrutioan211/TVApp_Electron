<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard TV App – Administrare</title>
  <style>
    :root { --bg: #1a1d23; --card: #252a33; --text: #e6e8ec; --muted: #8b909a; --accent: #4a9eff; --danger: #e85d6a; --green: #4ade80; --red: #f87171; }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 24px; padding-bottom: 200px; position: relative; }
    h1 { font-size: 1.5rem; margin: 0 0 20px; }
    .row { display: flex; gap: 24px; flex-wrap: wrap; align-items: flex-start; }
    .card { background: var(--card); border-radius: 10px; padding: 20px; min-width: 280px; }
    .card h2 { font-size: 1rem; margin: 0 0 12px; color: var(--muted); }
    input, select, button { padding: 8px 12px; border-radius: 6px; border: 1px solid #3d434e; background: #2d323c; color: var(--text); }
    button { cursor: pointer; background: var(--accent); color: #fff; border: none; text-align: center; }
    button.danger { background: var(--danger); }
    button.small { padding: 5px 10px; font-size: 0.8rem; min-width: 0; text-align: center; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; white-space: nowrap; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    input:read-only, select:read-only, input.locked, select.locked { opacity: 0.85; cursor: not-allowed; }
    ul { list-style: none; padding: 0; margin: 0; }
    #teamList li { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; margin: 2px 0; border-radius: 8px; gap: 8px; cursor: pointer; transition: background 0.15s ease; }
    #teamList { margin-top: 50px; }
    #teamList li:hover { background: rgba(74, 158, 255, 0.12); }
    #teamList li.active { background: rgba(74, 158, 255, 0.25); border: 1px solid var(--accent); font-weight: 600; }
    .playlist-editor { flex: 1; min-width: 480px; }
    .playlist-editor.collapsed { min-height: 0; }
    .playlist-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; padding: 4px 0; }
    .playlist-header:hover { color: var(--accent); }
    .playlist-toggle { font-size: 1.2rem; transition: transform 0.2s; }
    .playlist-editor.collapsed .playlist-toggle { transform: rotate(-90deg); }
    .playlist-body { overflow: hidden; }
    .playlist-editor.collapsed .playlist-body { display: none; }
    .sections-zone { margin-top: 24px; }
    .sections-zone h2 { font-size: 1rem; margin: 0 0 12px; color: var(--muted); }
    .section-card { background: var(--card); border-radius: 10px; padding: 12px 16px; margin-bottom: 8px; min-height: 0; }
    .section-card.collapsed .section-body { display: none; }
    .section-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; padding: 2px 0; }
    .section-header:hover { color: var(--accent); }
    .section-card .section-toggle { font-size: 1.1rem; transition: transform 0.2s; }
    .section-card.collapsed .section-toggle { transform: rotate(-90deg); }
    .section-body { margin-top: 12px; }
    .section-body textarea { width: 100%; min-height: 120px; font-family: monospace; font-size: 0.8rem; padding: 10px; border-radius: 6px; background: #2d323c; color: var(--text); resize: vertical; }
    .section-actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .section-item-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 10px; }
    .section-item-table th, .section-item-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #3d434e; }
    .section-item-table th { color: var(--muted); font-weight: 600; }
    .section-item-table input, .section-item-table select { width: 100%; min-width: 0; }
    .section-item-table .col-actions { width: 90px; text-align: center; }
    .section-subtitle { font-size: 0.85rem; color: var(--muted); margin: 12px 0 6px; }
    .section-anniversary-collapsible .section-anniversary-collapsible-header { cursor: pointer; user-select: none; font-weight: 600; font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .section-anniversary-collapsible .section-anniversary-collapsible-header:hover { color: var(--fg); }
    .section-anniversary-collapsible .section-anniversary-collapsible-header .toggle-icon { font-size: 0.7rem; transition: transform 0.15s ease; }
    .section-anniversary-collapsible:not(.collapsed) .section-anniversary-collapsible-header .toggle-icon { transform: rotate(90deg); }
    .section-anniversary-collapsible.collapsed .section-anniversary-collapsible-content { display: none; }
    .section-object-fields { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-bottom: 12px; }
    .section-object-fields label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 2px; }
    .sections-team-label { color: var(--accent); font-weight: 600; }
    .slide-row { display: grid; grid-template-columns: 90px 1fr 64px 72px 72px 1fr 1fr 100px 72px 72px 1fr 64px; gap: 8px; align-items: center; padding: 10px 0; border-bottom: 1px solid #3d434e; font-size: 0.85rem; }
    .slide-row > button { justify-self: center; }
    .slide-row .row-action { justify-self: center; display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
    .slide-row .range-input { min-width: 0; font-size: 0.8rem; padding: 4px 8px; }
    .slide-row .range-readonly { font-size: 0.8rem; color: var(--muted); padding: 4px 8px; }
    .slide-row .sound-readonly { font-size: 0.8rem; color: var(--muted); padding: 4px 8px; }
    .slide-row .fill-readonly { font-size: 0.8rem; color: var(--muted); padding: 4px 8px; }
    .slide-row .sound-cell, .slide-row .fill-cell { width: 100%; min-width: 52px; font-size: 0.85rem; padding: 6px 8px; cursor: pointer; }
    .btn-convert { background: #8b5cf6; color: #fff; }
    .converted-label { color: var(--muted); font-size: 0.8rem; padding: 4px 8px; }
    .slide-row .type { min-width: 82px; padding: 6px 8px; }
    .slide-row.disabled-row { opacity: 0.42; background: rgba(0,0,0,0.2); }
    .slide-row.disabled-row input, .slide-row.disabled-row select { opacity: 0.85; }
    .slide-row button.small { min-width: 58px; padding: 6px 10px; font-size: 0.78rem; }
    .btn-enable { background: #22c55e; color: #0f172a; }
    .btn-enable:hover { background: #4ade80; }
    .btn-disable { background: #64748b; color: #e2e8f0; }
    .btn-disable:hover { background: #94a3b8; }
    .btn-row-save { background: var(--accent); color: #fff; }
    .btn-upload { background: #0ea5e9; color: #fff; }
    .slide-row.head { color: var(--muted); font-weight: 600; padding-bottom: 8px; }
    .slide-row.head span { text-align: center; }
    .slide-row input { width: 100%; }
    .msg { margin-top: 12px; padding: 8px 12px; border-radius: 6px; }
    .msg.ok { background: #1e3a2f; color: #8fdcb4; }
    .msg.err { background: #3a1e1e; color: #dc8f8f; }
    .dashboard-lock { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .dashboard-lock.hidden { display: none; }
    .dashboard-lock p { background: var(--card); padding: 24px; border-radius: 12px; max-width: 360px; text-align: center; }
    .git-zone { position: fixed; top: 16px; right: 16px; display: flex; align-items: center; gap: 10px; z-index: 101; }
    .git-widget { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--card); border-radius: 8px; cursor: pointer; user-select: none; border: 1px solid #3d434e; }
    .git-widget:hover { border-color: var(--accent); }
    .git-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--red); transition: background 0.2s; }
    .git-dot.connected { background: var(--green); }
    .btn-push, .btn-pull { padding: 8px 14px; font-size: 0.9rem; }
    .btn-push.hidden, .btn-pull.hidden { display: none; }
    .clean-workspace-zone { position: fixed; bottom: 16px; left: 16px; z-index: 101; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
    .clean-workspace-zone.hidden { display: none; }
    .btn-clean-workspace { background: var(--danger); color: #fff; padding: 8px 14px; font-size: 0.85rem; border-radius: 8px; border: none; cursor: pointer; }
    .btn-clean-workspace:hover { background: #f87171; }
    .file-input-hidden { position: absolute; width: 0; height: 0; opacity: 0; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; z-index: 200; }
    .loading-overlay.hidden { display: none; }
    .loading-overlay .spinner { width: 48px; height: 48px; border: 4px solid #3d434e; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    .loading-overlay .text { color: var(--text); font-size: 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 150; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.hidden { display: none; }
    .modal-box { background: var(--card); border-radius: 12px; padding: 24px; max-width: 480px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-box h3 { margin: 0 0 16px; font-size: 1.1rem; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 4px; color: var(--muted); font-size: 0.9rem; }
    .form-group input, .form-group select { width: 100%; }
    .form-group-inline { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .form-group-inline .label-with-checkbox { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 0; cursor: pointer; }
    .form-group-inline .label-with-checkbox input[type="checkbox"] { width: auto; }
    .form-group-inline .hint { color: var(--muted); font-size: 0.85rem; }
    .form-panel { display: none; }
    .form-panel.visible { display: block; }
    .form-actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .form-status { margin-top: 10px; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; }
    .form-status.ok { background: #1e3a2f; color: #8fdcb4; }
    .form-status.err { background: #3a1e1e; color: #dc8f8f; }
    .form-status.hint { background: #2d323c; color: var(--muted); }
    #addSlideModal select, #addSlideModal input:not([readonly]) { cursor: pointer; }
    #addSlideModal input[type="text"], #addSlideModal input[type="number"] { cursor: text; }
    .title-with-status { display: flex; align-items: center; gap: 12px; margin: 0 0 16px; flex-wrap: wrap; }
    .title-with-status .status-line { font-size: 0.8rem; color: var(--muted); display: inline-flex; align-items: center; gap: 8px; margin: 0; font-weight: normal; }
    .title-with-status .status-line::before { content: ''; display: inline-block; width: 24px; height: 1px; background: var(--muted); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.green { background: var(--green); }
    .status-dot.yellow { background: #eab308; }
    .status-dot.red { background: var(--red); }
  </style>
</head>
<body>
  <div class="git-zone">
    <div class="git-widget" id="gitWidget" title="Click pentru a verifica conexiunea Git și a sincroniza repository (pull)">
      <span class="git-dot" id="gitDot"></span>
      <span>Check GIT Connect & Sync</span>
    </div>
    <button type="button" class="btn-push hidden" id="btnPush">Push changes</button>
    <button type="button" class="btn-pull hidden" id="btnPull">Pull</button>
  </div>
  <div class="clean-workspace-zone hidden" id="cleanWorkspaceZone">
    <div class="clean-workspace-status" style="display: inline-flex; align-items: center; gap: 8px; margin-right: 12px; padding: 6px 12px; background: var(--card); border-radius: 8px; border: 1px solid #3d434e;">
      <span class="status-dot" id="changeStatusDotBottom"></span>
      <span class="status-line" id="changeStatusTextBottom" style="font-size: 0.8rem; color: var(--muted);">Up to date</span>
    </div>
    <button type="button" class="btn-clean-workspace" id="btnCleanWorkspace" title="Șterge din documents/photos/videos ce nu e referit în playlist.json">Clean Workspace (Integrator only)</button>
  </div>

  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner"></div>
    <span class="text" id="loadingText">Loading...</span>
  </div>

  <div class="dashboard-lock" id="dashboardLock">
    <p>Conectați Git pentru a avea acces la setări.<br/>Apăsați „Check GIT Connect & Sync” (colț dreapta sus).</p>
  </div>

  <h1 class="title-with-status">
    Dashboard TV App – Administrare
    <span class="status-line" id="changeStatusLine">
      <span class="status-dot green" id="changeStatusDot"></span>
      <span id="changeStatusText">Up to date</span>
    </span>
  </h1>
  <div class="row">
    <div class="card">
      <h2>Echipe</h2>
      <form id="formTeam">
        <input type="text" id="teamName" placeholder="Nume echipă nouă" required />
        <button type="submit" style="margin-top: 8px;">Adaugă</button>
      </form>
      <ul id="teamList"></ul>
    </div>
    <div class="card playlist-editor collapsed" id="playlistCard">
      <div class="playlist-header" id="playlistHeader">
        <h2 style="margin:0;">Playlist – <span id="currentTeam">(selectează o echipă)</span></h2>
        <span class="playlist-toggle" id="playlistToggle">▶</span>
      </div>
      <div class="playlist-body">
        <div class="slide-row head">
          <span>Tip</span><span>Src / URL</span><span>Dur. (sec / pag la doc)</span><span>Sound</span><span>Fill</span><span>Titlu</span><span>Subtitlu</span><span>Range</span><span>Enable</span><span>Disable</span><span>Acțiune</span><span></span>
        </div>
        <div id="slideList"></div>
        <button type="button" id="addSlide" style="margin-top: 12px;" disabled>+ Adaugă slide</button>
        <button type="button" id="savePlaylist" style="margin-top: 8px; margin-left: 8px;" disabled>Salvează playlist</button>
        <div id="msg"></div>
      </div>
    </div>
  </div>

  <div class="sections-zone" id="sectionsZone">
    <h2>Secțiuni conținut <span id="sectionsTeamName" class="sections-team-label"></span></h2>
    <div id="sectionCards"></div>
  </div>

  <div class="modal-overlay hidden" id="cleanResultModal">
    <div class="modal-box" style="max-width: 520px;">
      <h3>Clean Workspace – șterse</h3>
      <pre id="cleanResultList" style="background: #2d323c; padding: 12px; border-radius: 8px; max-height: 280px; overflow: auto; font-size: 0.85rem; white-space: pre-wrap; word-break: break-all;"></pre>
      <p class="form-status hint clean-result-push-hint" style="margin-top: 10px;">Push va rula după ce apeși Continuă cu Push.</p>
      <div class="form-actions" style="margin-top: 16px;">
        <button type="button" id="cleanResultPushBtn">Continuă cu Push</button>
        <button type="button" class="small" id="cleanResultCloseBtn" style="display: none;">Închide</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay hidden" id="addSlideModal">
    <div class="modal-box">
      <h3>Adaugă slide</h3>
      <div class="form-group">
        <label>Tip</label>
        <select id="modalType">
          <option value="image">Image</option>
          <option value="video">Video</option>
          <option value="web_url">Web URL</option>
          <option value="vimeo">Vimeo</option>
          <option value="hls">Hls Video</option>
          <option value="pdf">PDF</option>
          <option value="word">Word</option>
          <option value="pptx">PowerPoint</option>
          <option value="excel">Excel</option>
        </select>
      </div>
      <div id="modalFormPanels">
        <div class="form-panel" data-type="image" id="panelImage">
          <div class="form-group"><label>image: Upload sau URL</label><input type="file" id="modalImageFile" accept="image/*" /><input type="text" id="modalImageUrl" placeholder="sau URL imagine" style="margin-top:6px;" /></div>
          <button type="button" class="small" id="modalImageUpload">Upload</button>
          <button type="button" class="small" id="modalImageValidateUrl">Validează URL</button>
          <div class="form-group"><label>Durata (sec)</label><input type="number" id="modalDuration" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalImageFillWidth" /> Fill width</label>
            <span class="hint">(set once, cannot be changed later)</span>
          </div>
          <div class="form-group"><label>Titlu (opțional)</label><input type="text" id="modalTitle" placeholder="Titlu" /></div>
          <div class="form-group"><label>Subtitlu (opțional)</label><input type="text" id="modalSubtitle" placeholder="Subtitlu" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabled"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="video" id="panelVideo">
          <div class="form-group"><label>video: Upload sau URL</label><input type="file" id="modalVideoFile" accept="video/*" /><input type="text" id="modalVideoUrl" placeholder="sau URL video" style="margin-top:6px;" /></div>
          <button type="button" class="small" id="modalVideoUpload">Upload</button>
          <button type="button" class="small" id="modalVideoValidateUrl">Validează URL</button>
          <div class="form-group"><label>Durata (sec)</label><input type="number" id="modalDurationV" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalVideoSound" /> With Sound</label>
            <span class="hint">(set once, cannot be changed later)</span>
          </div>
          <div class="form-group"><label>Titlu (opțional)</label><input type="text" id="modalTitleV" /></div>
          <div class="form-group"><label>Subtitlu (opțional)</label><input type="text" id="modalSubtitleV" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledV"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="web_url" id="panelWebUrl">
          <div class="form-group"><label>URL</label><input type="text" id="modalWebUrl" placeholder="https://..." /></div>
          <button type="button" class="small" id="modalWebUrlValidate">Validează URL</button>
          <p class="form-status hint">Opțional: convertiți pagina în imagini (ca la Word) pentru afișare stabilă în slideshow.</p>
          <div class="form-group"><label>Range (all = o imagine full page; 1-5 = 5 ecrane)</label><input type="text" id="modalWebRange" value="all" placeholder="all, 1-5" /></div>
          <button type="button" class="small btn-convert" id="modalWebConvert">Convert</button>
          <p class="form-status hint" id="modalWebConvertHint">Setați URL, opțional range, apăsați Convert. Apoi Validează form și Finalizare.</p>
          <div class="form-group"><label>Durata (sec) / durata per imagine la Convert</label><input type="number" id="modalDurationW" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalWebFillWidth" /> Fill width</label>
            <span class="hint">(set once, for converted)</span>
          </div>
          <div class="form-group"><label>Titlu (opțional)</label><input type="text" id="modalTitleW" /></div>
          <div class="form-group"><label>Subtitlu (opțional)</label><input type="text" id="modalSubtitleW" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledW"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="vimeo" id="panelVimeo">
          <div class="form-group"><label>URL Vimeo</label><input type="text" id="modalVimeoUrl" placeholder="https://vimeo.com/..." /></div>
          <button type="button" class="small" id="modalVimeoValidate">Validează</button>
          <div class="form-group"><label>Durata (sec)</label><input type="number" id="modalDurationVi" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalVimeoSound" /> With Sound</label>
            <span class="hint">(set once, cannot be changed later)</span>
          </div>
          <div class="form-group"><label>Titlu / Subtitlu (opțional)</label><input type="text" id="modalTitleVi" /><input type="text" id="modalSubtitleVi" placeholder="Subtitlu" style="margin-top:4px;" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledVi"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="hls" id="panelHls">
          <div class="form-group"><label>URL HLS (.m3u8)</label><input type="text" id="modalHlsUrl" placeholder="https://..." /></div>
          <button type="button" class="small" id="modalHlsValidate">Validează</button>
          <div class="form-group"><label>Durata (sec)</label><input type="number" id="modalDurationH" value="60" min="1" /></div>
          <div class="form-group"><label>Titlu / Subtitlu (opțional)</label><input type="text" id="modalTitleH" /><input type="text" id="modalSubtitleH" placeholder="Subtitlu" style="margin-top:4px;" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledH"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="pdf" id="panelPdf">
          <div class="form-group"><label>Fișier PDF</label><input type="file" id="modalPdfFile" accept=".pdf" /></div>
          <button type="button" class="small" id="modalPdfUpload">Upload</button>
          <div class="form-group"><label>Range (ex: all; 1-5; 1,3,5)</label><input type="text" id="modalPdfRange" value="all" placeholder="all, 1-5, 1,3,5" /></div>
          <button type="button" class="small btn-convert" id="modalPdfConvert">Convert</button>
          <p class="form-status hint" id="modalPdfConvertHint">Încărcați PDF, setați range și apăsați Convert. Apoi Validează form.</p>
          <div class="form-group"><label>Durata per pagină (sec)</label><input type="number" id="modalDurationPdf" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalPdfFillWidth" /> Fill width</label>
            <span class="hint">(set once)</span>
          </div>
          <div class="form-group"><label>Titlu / Subtitlu (opțional)</label><input type="text" id="modalTitlePdf" /><input type="text" id="modalSubtitlePdf" placeholder="Subtitlu" style="margin-top:4px;" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledPdf"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="word" id="panelWord">
          <div class="form-group"><label>Fișier Word</label><input type="file" id="modalWordFile" accept=".doc,.docx" /></div>
          <button type="button" class="small" id="modalWordUpload">Upload</button>
          <div class="form-group"><label>Range (ex: all; 1-5; 1,3,5)</label><input type="text" id="modalWordRange" value="all" placeholder="all, 1-5, 1,3,5" /></div>
          <button type="button" class="small btn-convert" id="modalWordConvert">Convert</button>
          <p class="form-status hint" id="modalWordConvertHint">Încărcați document, setați range și apăsați Convert. Apoi Validează form.</p>
          <div class="form-group"><label>Durata per pagină (sec)</label><input type="number" id="modalDurationWord" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalWordFillWidth" /> Fill width</label>
            <span class="hint">(set once)</span>
          </div>
          <div class="form-group"><label>Titlu / Subtitlu (opțional)</label><input type="text" id="modalTitleWord" /><input type="text" id="modalSubtitleWord" placeholder="Subtitlu" style="margin-top:4px;" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledWord"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="pptx" id="panelPptx">
          <div class="form-group"><label>Fișier PowerPoint</label><input type="file" id="modalPptxFile" accept=".ppt,.pptx" /></div>
          <button type="button" class="small" id="modalPptxUpload">Upload</button>
          <div class="form-group"><label>Range (ex: all; 1-5; 1,3,5)</label><input type="text" id="modalPptxRange" value="all" placeholder="all, 1-5, 1,3,5" /></div>
          <button type="button" class="small btn-convert" id="modalPptxConvert">Convert</button>
          <p class="form-status hint" id="modalPptxConvertHint">Încărcați PPT/PPTX, setați range și apăsați Convert. Apoi Validează form.</p>
          <div class="form-group"><label>Durata per pagină (sec)</label><input type="number" id="modalDurationPptx" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalPptxFillWidth" /> Fill width</label>
            <span class="hint">(set once)</span>
          </div>
          <div class="form-group"><label>Titlu / Subtitlu (opțional)</label><input type="text" id="modalTitlePptx" /><input type="text" id="modalSubtitlePptx" placeholder="Subtitlu" style="margin-top:4px;" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledPptx"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
        <div class="form-panel" data-type="excel" id="panelExcel">
          <div class="form-group"><label>Fișier Excel</label><input type="file" id="modalExcelFile" accept=".xls,.xlsx" /></div>
          <button type="button" class="small" id="modalExcelUpload">Upload</button>
          <div class="form-group"><label>Range (ex: all; 1-5; 1,3,5)</label><input type="text" id="modalExcelRange" value="all" placeholder="all, 1-5, 1,3,5" /></div>
          <button type="button" class="small btn-convert" id="modalExcelConvert">Convert</button>
          <p class="form-status hint" id="modalExcelConvertHint">Încărcați XLS/XLSX, setați range și apăsați Convert. Apoi Validează form.</p>
          <div class="form-group"><label>Durata per pagină (sec)</label><input type="number" id="modalDurationExcel" value="60" min="1" /></div>
          <div class="form-group form-group-inline">
            <label class="label-with-checkbox"><input type="checkbox" id="modalExcelFillWidth" /> Fill width</label>
            <span class="hint">(set once)</span>
          </div>
          <div class="form-group"><label>Titlu / Subtitlu (opțional)</label><input type="text" id="modalTitleExcel" /><input type="text" id="modalSubtitleExcel" placeholder="Subtitlu" style="margin-top:4px;" /></div>
          <div class="form-group"><label>Afișare</label><select id="modalEnabledExcel"><option value="1">Enable</option><option value="0">Disable</option></select></div>
        </div>
      </div>
      <div class="form-status hidden" id="modalFormStatus"></div>
      <div class="form-actions">
        <button type="button" class="small" id="modalValidateBtn">Validează form</button>
        <button type="button" id="modalFinalizeBtn" disabled>Finalizare</button>
        <button type="button" class="small" id="modalCancelBtn">Anulare</button>
      </div>
    </div>
  </div>

  <script>
    const api = (path, opts = {}) => fetch(path, { headers: opts.headers || {}, ...opts }).then(r => r.json());
    let selectedTeam = null;
    let slides = [];
    let gitConnected = false;

    const FILE_TYPES = ['image', 'video'];
    const URL_TYPES = ['web_url', 'vimeo', 'hls'];
    const DOC_TYPES = ['pdf', 'pptx', 'word', 'excel'];
    const TYPES = [...FILE_TYPES, ...URL_TYPES, ...DOC_TYPES];

    const SECTION_LABELS = {
      announcements: 'Announcements',
      canteen_menu: 'Canteen menu',
      anniversary: 'Anniversary',
      uptime_services: 'Uptime services',
      info_section: 'Info section',
      projects_info: 'Projects info',
      stretching: 'Stretching',
      meeting_rooms: 'Meeting rooms',
      traffic: 'Traffic'
    };
    const COOLDOWN_SECTION_IDS = ['announcements', 'anniversary', 'uptime_services', 'info_section', 'projects_info', 'meeting_rooms'];
    const COOLDOWN_DEFAULTS = { announcements: 120, anniversary: 20, uptime_services: 120, info_section: 10, projects_info: 120, meeting_rooms: 60 };
    // Schema: listKey, columns, defaultItem. itemIsString | htmlEditor | emptySection | customAnniversary | multiListInfo | singleItem | maxItems
    const SECTION_SCHEMAS = {
      announcements: { listKey: 'items', itemIsString: true, htmlEditor: true, columns: [{ key: 'text', label: 'Text (HTML)' }], defaultItem: '' },
      canteen_menu: { listKey: 'slots', columns: [{ key: 'time', label: 'Ora' }, { key: 'duration', label: 'Durată' }], defaultItem: { time: '10:30', duration: '15 min' }, extraKeys: ['restaurant'] },
      anniversary: { customAnniversary: true },
      uptime_services: { listKey: 'services', columns: [{ key: 'id', label: 'ID' }, { key: 'name', label: 'Nume serviciu' }, { key: 'statusUrl', label: 'Status URL' }], defaultItem: { id: '', name: '', statusUrl: '' } },
      info_section: { infoSectionEditor: true },
      projects_info: { listKey: 'projects', columns: [{ key: 'name', label: 'Nume' }, { key: 'start', label: 'Start' }, { key: 'end', label: 'End' }, { key: 'status', label: 'Status', type: 'select', options: ['normal', 'task_force', 'maintenance', 'change_request'] }, { key: 'icon', label: 'Icon', type: 'image' }], defaultItem: { name: '', start: '', end: '', status: 'normal', icon: '' } },
      stretching: { listKey: 'items', singleItem: true, maxItems: 1, columns: [{ key: 'video', label: 'Video', type: 'video' }, { key: 'title', label: 'Titlu' }, { key: 'subtitle', label: 'Subtitlu' }, { key: 'time', label: 'Ora (24h)', type: 'time' }, { key: 'duration', label: 'Durată (ex: 10 min)' }], defaultItem: { video: '', title: '', subtitle: '', time: '', duration: '' } },
      meeting_rooms: { listKey: 'rooms', columns: [{ key: 'name', label: 'Nume sală' }], defaultItem: { name: '' } },
      traffic: { listKey: 'destinations', maxItems: 3, columns: [{ key: 'destination', label: 'Destinație' }], defaultItem: { destination: '' }, originFixed: 'Aumovio Sibiu - Strada Salzburg' },
      projects_info: { listKey: 'projects', columns: [{ key: 'name', label: 'Nume' }, { key: 'start', label: 'Start' }, { key: 'end', label: 'End' }, { key: 'status', label: 'Status', type: 'select', options: ['normal', 'task_force', 'maintenance', 'change_request'] }, { key: 'icon', label: 'Icon', type: 'image' }], defaultItem: { name: '', start: '', end: '', status: 'normal', icon: '' } }
    };
    const SECTION_DEFAULTS = {
      announcements: {
        cooldownSeconds: 120,
        items: [
          'Quarterly town hall today at 16:00, Sky Auditorium – all teams invited.',
          'New security badges required from next week. Collect at reception.',
          'Building maintenance: elevators B block on Saturday 08:00–12:00.',
          'Canteen closed Friday 14:00–16:00 for staff event.',
          'Reminder: Please update your project hours in the booking system by EOD.'
        ]
      },
      canteen_menu: { slots: [{ time: '10:30', duration: '15 min' }, { time: '11:30', duration: '15 min' }], restaurant: { name: 'La Turn', tagline: 'Restaurant & Terrace — recomandat de echipa' } },
      anniversary: {
        cooldownSeconds: 20,
        people: [
          { name: 'Laura Popa', birthday: '1990-03-15', newColleague: false, workStartDate: '2019-02-01' },
          { name: 'George Mihai', birthday: '1988-07-22', newColleague: false, workStartDate: '2021-02-01' },
          { name: 'Simona Marin', birthday: '1992-11-08', newColleague: true, workStartDate: '2025-01-15' }
        ],
        employeeOfMonth: ['Laura Popa', 'George Mihai'],
        jobOpenings: [
          { title: 'Senior Frontend Developer', team: 'Product' },
          { title: 'Data Engineer', team: 'Analytics' }
        ],
        events: [
          { name: 'Team Building', date: '2025-04-12', time: '09:00' },
          { name: 'Tech Talk: Security', date: '2025-04-15', time: '14:00' }
        ]
      },
      uptime_services: {
        cooldownSeconds: 120,
        services: [
          { id: 'github', name: 'GitHub', statusUrl: '', up: true },
          { id: 'jira', name: 'Jira', statusUrl: '', up: true },
          { id: 'slack', name: 'Slack', statusUrl: '', up: true },
          { id: 'jenkins', name: 'Jenkins', statusUrl: '', up: true },
          { id: 'monitor', name: 'Monitor', statusUrl: '', up: false }
        ]
      },
      info_section: {
        cooldownSeconds: 10,
        customerFeedback: [
          { client: 'AutoTech GmbH', quote: 'Outstanding partnership. The team delivered beyond our expectations and the integration was seamless.' },
          { client: 'Mobility Solutions', quote: 'Professional and responsive. They understood our automotive requirements from day one.' },
          { client: 'Drive Systems Inc.', quote: "Aumovio's expertise in the sector made the difference. We highly recommend them." }
        ],
        quotesOfDay: [
          { quote: "Innovation is not about saying yes to everything. It's about saying no to all but the most crucial features.", used: true },
          { quote: 'The best time to plant a tree was 20 years ago. The second best time is now.', used: true },
          { quote: 'Quality is not an act, it is a habit.', used: true }
        ],
        didYouKnow: [
          { fact: 'The automotive industry is one of the largest R&D investors globally, with billions spent on electrification and autonomous driving each year.' },
          { fact: 'Aumovio was founded with a focus on bringing software excellence to mobility and manufacturing. Our first project was in powertrain calibration.' },
          { fact: "Modern vehicles contain over 100 million lines of code—more than many operating systems. Software is at the heart of today's cars." }
        ],
        wordOfDay: [
          { word: 'Calibration', meaning: 'The process of adjusting and configuring a system (e.g. engine, sensor) to meet specified performance criteria.' },
          { word: 'OEM', meaning: 'Original Equipment Manufacturer. A company that produces parts or systems used in another company\'s end product.' },
          { word: 'ECU', meaning: 'Electronic Control Unit. A microcontroller that manages one or more electrical systems in a vehicle.' }
        ],
        reminderHealthy: [
          { title: 'Take a break', text: 'Step away from your screen every 1 hour. Short breaks reduce eye strain and improve focus.' },
          { title: 'Stay hydrated', text: 'Keep a bottle of water at your desk. Hydration supports concentration and overall well-being.' },
          { title: 'Simple stretching', text: 'A few minutes of stretching keeps muscles relaxed and helps prevent tension. Your body will thank you.' }
        ]
      },
      projects_info: {
        cooldownSeconds: 120,
        projects: [
          { name: 'Alpha', start: '2025-01-15', end: '2025-06-30', status: 'normal', icon: '' },
          { name: 'Beta', start: '2025-02-01', end: '2025-08-15', status: 'task_force', icon: '' },
          { name: 'Gamma', start: '2024-11-01', end: '2025-02-28', status: 'maintenance', icon: '' },
          { name: 'Delta', start: '2025-03-01', end: '2025-09-30', status: 'normal', icon: '' }
        ]
      },
      stretching: { items: [] },
      meeting_rooms: {
        cooldownSeconds: 60,
        rooms: [
          { name: 'Room A' },
          { name: 'Room B' },
          { name: 'Room C' }
        ]
      },
      traffic: {
        origin: 'Aumovio Sibiu - Strada Salzburg',
        destinations: [
          { destination: 'Centru Sibiu' },
          { destination: 'Doamna Stanca Sibiu' },
          { destination: 'Vasile Aron Sibiu' }
        ]
      }
    };

    const GIT_CACHE_KEY = 'dashboard_git_connected';
    const GIT_COMMIT_KEY = 'dashboard_git_commit';
    let savedCommit = '';

    function setLoading(show, text) {
      const el = document.getElementById('loadingOverlay');
      el.classList.toggle('hidden', !show);
      document.getElementById('loadingText').textContent = text || 'Loading...';
    }

    function setGitConnected(ok) {
      gitConnected = ok;
      try {
        localStorage.setItem(GIT_CACHE_KEY, ok ? 'true' : 'false');
        if (ok && savedCommit) localStorage.setItem(GIT_COMMIT_KEY, savedCommit);
      } catch (e) {}
      document.getElementById('gitDot').classList.toggle('connected', ok);
      document.getElementById('dashboardLock').classList.toggle('hidden', ok);
      document.getElementById('btnPush').classList.toggle('hidden', !ok);
      if (!ok) document.getElementById('btnPull').classList.add('hidden');
      document.getElementById('cleanWorkspaceZone').classList.toggle('hidden', !ok);
    }

    function showPullButton(show) {
      document.getElementById('btnPull').classList.toggle('hidden', !show);
    }

    document.getElementById('gitWidget').addEventListener('click', async () => {
      const dot = document.getElementById('gitDot');
      dot.style.opacity = '0.6';
      setLoading(true, 'Syncing...');
      let pullOk = false;
      try {
        const pullRes = await api('/api/git/pull', { method: 'POST' });
        pullOk = pullRes.ok;
      } catch (e) {}
      const res = await api('/api/git/connect');
      setLoading(false);
      dot.style.opacity = '';
      if (res.ok) {
        savedCommit = res.commit || '';
        try { if (savedCommit) localStorage.setItem(GIT_COMMIT_KEY, savedCommit); } catch (e) {}
        setGitConnected(true);
        showMsg(pullOk ? 'Git connected. Repository synced.' : 'Git connected.', true);
        showPullButton(false);
      } else {
        setGitConnected(false);
        showMsg(res.error || 'Git connection failed.', false);
      }
    });

    document.getElementById('btnPush').addEventListener('click', async () => {
      if (!gitConnected) return;
      setLoading(true, 'Salvare playlist...');
      await savePlaylistSilent();
      setLoading(true, 'Pushing...');
      let res;
      try {
        res = await api('/api/git/push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ expectedCommit: savedCommit })
        });
      } catch (e) {
        res = { ok: false, error: 'Request failed.' };
      }
      setLoading(false);
      if (res.ok) {
        if (res.commit) {
          savedCommit = res.commit;
          try { localStorage.setItem(GIT_COMMIT_KEY, savedCommit); } catch (e) {}
        }
        setChangeStatus('up_to_date');
        showMsg(res.message || 'Push successful.', true);
        showPullButton(false);
      } else {
        showMsg(res.error || 'Push failed.', false);
        if (res.needPull) showPullButton(true);
      }
    });

    document.getElementById('btnPull').addEventListener('click', async () => {
      if (!gitConnected) return;
      setLoading(true, 'Pulling...');
      let res;
      try {
        res = await api('/api/git/pull', { method: 'POST' });
      } catch (e) {
        res = { ok: false, error: 'Request failed.' };
      }
      setLoading(false);
      if (res.ok) {
        location.reload();
      } else {
        showMsg(res.error || 'Pull failed.', false);
      }
    });

    document.getElementById('btnCleanWorkspace').addEventListener('click', async () => {
      if (!gitConnected) return;
      if (!confirm('Clean Workspace: va șterge din documents/photos/videos tot ce nu este referit în playlist.json. Continuă?')) return;
      setLoading(true, 'Cleaning...');
      let res;
      try {
        res = await api('/api/git/clean-workspace', { method: 'POST' });
      } catch (e) {
        res = { ok: false, errors: ['Request failed.'], deleted: [] };
      }
      setLoading(false);
      const deleted = res.deleted || [];
      const listEl = document.getElementById('cleanResultList');
      const pushBtn = document.getElementById('cleanResultPushBtn');
      const closeBtn = document.getElementById('cleanResultCloseBtn');
      const pushHint = document.querySelector('.clean-result-push-hint');
      if (deleted.length) {
        listEl.textContent = deleted.join('\n');
        pushBtn.style.display = '';
        closeBtn.style.display = 'none';
        if (pushHint) pushHint.style.display = '';
      } else {
        listEl.textContent = '(Nimic șters.)';
        pushBtn.style.display = 'none';
        closeBtn.style.display = 'inline-flex';
        if (pushHint) pushHint.style.display = 'none';
      }
      document.getElementById('cleanResultModal').classList.remove('hidden');
      if (selectedTeam && deleted.length) loadPlaylist(selectedTeam);
    });

    document.getElementById('cleanResultCloseBtn').addEventListener('click', () => {
      document.getElementById('cleanResultModal').classList.add('hidden');
    });

    document.getElementById('cleanResultPushBtn').addEventListener('click', async () => {
      document.getElementById('cleanResultModal').classList.add('hidden');
      setLoading(true, 'Pushing...');
      await savePlaylistSilent();
      let res;
      try {
        res = await api('/api/git/push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ expectedCommit: savedCommit })
        });
      } catch (e) {
        res = { ok: false, error: 'Request failed.' };
      }
      setLoading(false);
      if (res.ok) {
        if (res.commit) {
          savedCommit = res.commit;
          try { localStorage.setItem(GIT_COMMIT_KEY, savedCommit); } catch (e) {}
        }
        setChangeStatus('up_to_date');
        showPullButton(false);
        alert('Push reușit. Modificările sunt în repository.');
      } else {
        showMsg(res.error || 'Push failed.', false);
        if (res.needPull) showPullButton(true);
      }
    });

    function showMsg(text, ok = true) {
      const el = document.getElementById('msg');
      el.textContent = text;
      el.className = 'msg ' + (ok ? 'ok' : 'err');
    }

    let playlistExpanded = false;
    let changeStatus = 'up_to_date';
    function setChangeStatus(status) {
      changeStatus = status;
      const cls = (status === 'up_to_date' ? 'green' : status === 'saved_unpushed' ? 'yellow' : 'red');
      const label = status === 'up_to_date' ? 'Up to date' : status === 'saved_unpushed' ? 'Saved but unpushed' : 'Unsaved and unpushed';
      const dot = document.getElementById('changeStatusDot');
      const text = document.getElementById('changeStatusText');
      if (dot) dot.className = 'status-dot ' + cls;
      if (text) text.textContent = label;
      const dotBottom = document.getElementById('changeStatusDotBottom');
      const textBottom = document.getElementById('changeStatusTextBottom');
      if (dotBottom) dotBottom.className = 'status-dot ' + cls;
      if (textBottom) textBottom.textContent = label;
    }
    function markUnsaved() {
      if (changeStatus === 'up_to_date' || changeStatus === 'saved_unpushed') setChangeStatus('unsaved');
    }
    function expandPlaylist() {
      playlistExpanded = true;
      document.getElementById('playlistCard').classList.remove('collapsed');
      document.getElementById('playlistToggle').textContent = '▼';
    }
    function collapsePlaylist() {
      playlistExpanded = false;
      document.getElementById('playlistCard').classList.add('collapsed');
      document.getElementById('playlistToggle').textContent = '▶';
    }
    function togglePlaylist() {
      playlistExpanded = !playlistExpanded;
      document.getElementById('playlistCard').classList.toggle('collapsed', !playlistExpanded);
      document.getElementById('playlistToggle').textContent = playlistExpanded ? '▼' : '▶';
    }

    async function loadTeams() {
      const list = await api('/api/teams');
      const teams = Array.isArray(list) ? list : [];
      const ul = document.getElementById('teamList');
      ul.innerHTML = teams.map(name => `
        <li data-name="${escapeHtml(name)}" class="${name === selectedTeam ? 'active' : ''}">
          <span>${escapeHtml(name)}</span>
          <button type="button" class="small danger" data-name="${escapeHtml(name)}">Șterge</button>
        </li>
      `).join('');
      ul.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); deleteTeam(btn.dataset.name); });
      });
      return teams;
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s == null ? '' : s;
      return d.innerHTML;
    }

    let sectionData = {};
    function getSectionList(sectionId) {
      const schema = SECTION_SCHEMAS[sectionId];
      const data = sectionData[sectionId] || SECTION_DEFAULTS[sectionId] || {};
      if (schema?.lists) return schema.lists.map(l => ({ ...l, arr: data[l.listKey] || [] }));
      if (schema?.listKey) return [{ listKey: schema.listKey, itemIsString: schema.itemIsString, columns: schema.columns, defaultItem: schema.defaultItem, slotsAsString: schema.slotsAsString, arr: Array.isArray(data[schema.listKey]) ? data[schema.listKey] : [] }];
      return [];
    }
    function readSectionCooldown(sectionId) {
      if (!COOLDOWN_SECTION_IDS.includes(sectionId)) return undefined;
      const card = document.querySelector('.section-card[data-section="' + sectionId + '"]');
      if (!card) return undefined;
      const inp = card.querySelector('[data-cooldown-input]');
      if (!inp) return undefined;
      const n = parseInt(inp.value, 10);
      return (isNaN(n) || n < 1) ? COOLDOWN_DEFAULTS[sectionId] : n;
    }
    function appendCooldownRow(body, sectionId) {
      if (!COOLDOWN_SECTION_IDS.includes(sectionId)) return;
      const data = sectionData[sectionId] || SECTION_DEFAULTS[sectionId] || {};
      const val = data.cooldownSeconds != null ? Number(data.cooldownSeconds) : COOLDOWN_DEFAULTS[sectionId];
      const wrap = document.createElement('div');
      wrap.className = 'section-cooldown-row';
      wrap.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;';
      wrap.innerHTML = '<label style="font-weight:600;font-size:0.85rem;">Cooldown (secunde)</label><input type="number" min="5" max="3600" step="1" data-cooldown-input value="' + escapeHtml(String(val)) + '" style="width:80px;" /><button type="button" class="small" data-cooldown-btn>Set cooldown</button>';
      wrap.querySelector('[data-cooldown-input]').addEventListener('input', () => { if (typeof markUnsaved === 'function') markUnsaved(); });
      const cooldownBtn = wrap.querySelector('[data-cooldown-btn]');
      cooldownBtn.addEventListener('click', async () => {
        if (!selectedTeam) { showMsg('Selectați o echipă.', false); return; }
        cooldownBtn.disabled = true;
        if (typeof setLoading === 'function') setLoading(true, 'Set cooldown...');
        try {
          const json = buildSectionJsonFromUI(sectionId);
          const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/section/' + encodeURIComponent(sectionId), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(json)
          });
          if (res.error) showMsg(res.error, false);
          else { sectionData[sectionId] = json; showMsg('Cooldown salvat. Secțiune ' + SECTION_LABELS[sectionId] + '.', true); if (typeof setChangeStatus === 'function') setChangeStatus('saved_unpushed'); }
        } finally {
          cooldownBtn.disabled = false;
          if (typeof setLoading === 'function') setLoading(false);
        }
      });
      body.appendChild(wrap);
    }
    function buildSectionJsonFromUI(sectionId) {
      const schema = SECTION_SCHEMAS[sectionId];
      const data = { ...(sectionData[sectionId] || SECTION_DEFAULTS[sectionId]) };
      if (schema?.originFixed) data.origin = schema.originFixed;
      if (schema?.emptySection) return {};
      if (schema?.customAnniversary) {
        const out = { people: [], employeeOfMonth: [], jobOpenings: [], events: [] };
        const peopleTbody = document.querySelector(`.section-card[data-section="${sectionId}"] .section-items-tbody[data-list="people"]`);
        if (peopleTbody) peopleTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const i = parseInt(row.dataset.index, 10);
          const nameEl = row.querySelector('[data-col="name"]');
          const birthdayEl = row.querySelector('[data-col="birthday"]');
          const newColEl = row.querySelector('[data-col="newColleague"]');
          const workEl = row.querySelector('[data-col="workStartDate"]');
          out.people.push({
            name: nameEl ? nameEl.value.trim() : '',
            birthday: birthdayEl ? (birthdayEl.value || '').slice(0, 10) : '',
            newColleague: newColEl ? newColEl.checked : false,
            workStartDate: workEl ? (workEl.value || '').slice(0, 10) : ''
          });
        });
        const eomTbody = document.querySelector(`.section-card[data-section="${sectionId}"] .section-items-tbody[data-list="employeeOfMonth"]`);
        if (eomTbody) eomTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const sel = row.querySelector('select[data-col="name"]');
          if (sel && sel.value) out.employeeOfMonth.push(sel.value);
        });
        const jobTbody = document.querySelector(`.section-card[data-section="${sectionId}"] .section-items-tbody[data-list="jobOpenings"]`);
        if (jobTbody) jobTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const titleEl = row.querySelector('[data-col="title"]');
          const teamEl = row.querySelector('[data-col="team"]');
          out.jobOpenings.push({ title: titleEl ? titleEl.value.trim() : '', team: teamEl ? teamEl.value.trim() : '' });
        });
        const eventsTbody = document.querySelector(`.section-card[data-section="${sectionId}"] .section-items-tbody[data-list="events"]`);
        if (eventsTbody) eventsTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const nameEl = row.querySelector('[data-col="name"]');
          const dateEl = row.querySelector('[data-col="date"]');
          const timeEl = row.querySelector('[data-col="time"]');
          out.events.push({
            name: nameEl ? nameEl.value.trim() : '',
            date: dateEl ? (dateEl.value || '').slice(0, 10) : '',
            time: timeEl ? (timeEl.value || '').slice(0, 5) : ''
          });
        });
        const cooldownVal = readSectionCooldown(sectionId);
        if (cooldownVal !== undefined) out.cooldownSeconds = cooldownVal;
        return out;
      }
      if (schema?.infoSectionEditor) {
        const out = { customerFeedback: [], quotesOfDay: [], didYouKnow: [], wordOfDay: [], reminderHealthy: [] };
        const card = document.querySelector(`.section-card[data-section="${sectionId}"]`);
        if (!card) return out;
        const cfTbody = card.querySelector('.section-items-tbody[data-list="customerFeedback"]');
        if (cfTbody) cfTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const clientEl = row.querySelector('[data-col="client"]');
          const quoteEl = row.querySelector('[data-col="quote"]');
          out.customerFeedback.push({ client: clientEl ? clientEl.value.trim() : '', quote: quoteEl ? quoteEl.value.trim() : '' });
        });
        const qdTbody = card.querySelector('.section-items-tbody[data-list="quotesOfDay"]');
        if (qdTbody) qdTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const quoteEl = row.querySelector('[data-col="quote"]');
          const usedEl = row.querySelector('[data-col="used"]');
          out.quotesOfDay.push({ quote: quoteEl ? quoteEl.value.trim() : '', used: usedEl ? usedEl.checked : false });
        });
        const dykTbody = card.querySelector('.section-items-tbody[data-list="didYouKnow"]');
        if (dykTbody) dykTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const factEl = row.querySelector('[data-col="fact"]');
          out.didYouKnow.push({ fact: factEl ? factEl.value.trim() : '' });
        });
        const wodTbody = card.querySelector('.section-items-tbody[data-list="wordOfDay"]');
        if (wodTbody) wodTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const wordEl = row.querySelector('[data-col="word"]');
          const meaningEl = row.querySelector('[data-col="meaning"]');
          out.wordOfDay.push({ word: wordEl ? wordEl.value.trim() : '', meaning: meaningEl ? meaningEl.value.trim() : '' });
        });
        const rhTbody = card.querySelector('.section-items-tbody[data-list="reminderHealthy"]');
        if (rhTbody) rhTbody.querySelectorAll('tr[data-index]').forEach(row => {
          const titleEl = row.querySelector('[data-col="title"]');
          const textEl = row.querySelector('[data-col="text"]');
          out.reminderHealthy.push({ title: titleEl ? titleEl.value.trim() : '', text: textEl ? textEl.value.trim() : '' });
        });
        const cooldownVal = readSectionCooldown(sectionId);
        if (cooldownVal !== undefined) out.cooldownSeconds = cooldownVal;
        return out;
      }
      if (schema?.customEditor) {
        const ta = document.querySelector(`.section-content[data-section="${sectionId}"]`);
        if (ta) try { return JSON.parse(ta.value || '{}'); } catch (e) { return data; }
        return data;
      }
      if (schema?.lists) {
        schema.lists.forEach(l => {
          const tbody = document.querySelector(`.section-items-tbody[data-section="${sectionId}"][data-list="${l.listKey}"]`);
          if (!tbody) return;
          const arr = [];
          tbody.querySelectorAll('tr[data-index]').forEach((row, idx) => {
            const i = parseInt(row.dataset.index, 10);
            if (l.itemIsString) {
              const input = row.querySelector('input');
              if (input) arr.push((input.value || '').trim());
            } else {
              const obj = {};
              l.columns.forEach(col => {
                const el = row.querySelector(`[data-col="${col.key}"]`);
                if (!el) return;
                let v = el.value;
                if (col.type === 'checkbox') v = el.checked;
                else if (col.key === 'progress') v = parseInt(v, 10) || 0;
                else if (col.key === 'joinMonth' || col.key === 'joinYear') v = parseInt(v, 10) || 0;
                obj[col.key] = v;
              });
              arr.push(obj);
            }
          });
          data[l.listKey] = arr;
        });
        return data;
      }
      if (schema?.listKey) {
        const tbody = document.querySelector(`.section-items-tbody[data-section="${sectionId}"]`);
        if (tbody) {
          const arr = [];
          const extraKey = schema.extraKeys;
          if (extraKey) {
            extraKey.forEach(k => {
              const wrap = document.querySelector(`.section-extra[data-section="${sectionId}"][data-key="${k}"]`);
              if (wrap && k === 'origin') { const i = wrap.querySelector('input'); if (i) data.origin = i.value || ''; }
              if (wrap && k === 'restaurant') {
                const o = {}; ['name', 'tagline'].forEach(f => { const i = wrap.querySelector(`[data-field="${f}"]`); if (i) o[f] = i.value || ''; });
                data.restaurant = o;
              }
            });
          }
          tbody.querySelectorAll('tr[data-index]').forEach((row) => {
            if (schema.itemIsString) {
              if (schema.htmlEditor) {
                const ed = row.querySelector('[data-html-editor]');
                if (ed) arr.push(ed.innerHTML || '');
              } else {
                const input = row.querySelector('input');
                if (input) arr.push((input.value || '').trim());
              }
            } else {
              const obj = {};
              schema.columns.forEach(col => {
                const el = row.querySelector(`[data-col="${col.key}"]`);
                if (!el) return;
                let v;
                if (col.type === 'checkbox') v = el.checked;
                else if (col.type === 'select') v = el.value;
                else if (col.type === 'image' || col.type === 'video') {
                  const idx = parseInt(row.dataset.index, 10);
                  const list = sectionData[sectionId] && sectionData[sectionId][schema.listKey];
                  v = (list && list[idx]) ? (list[idx][col.key] || '') : '';
                } else v = el.value;
                if (col.key === 'progress' || col.key === 'minutes') v = parseInt(v, 10) || 0;
                else if (col.key === 'slots' && schema.slotsAsString) {
                  v = (v || '').split(',').map(s => s.trim()).filter(Boolean);
                }
                obj[col.key] = v;
              });
              arr.push(obj);
            }
          });
          data[schema.listKey] = arr;
          if (sectionId === 'uptime_services') arr.forEach(s => { if (s.up === undefined) s.up = true; });
        }
      }
      if (!schema?.listKey && schema?.extraKeys?.length) {
        schema.extraKeys.forEach(k => {
          const wrap = document.querySelector(`.section-extra[data-section="${sectionId}"][data-key="${k}"]`);
          if (wrap && k === 'restaurant') {
            const o = {}; ['name', 'tagline'].forEach(f => { const i = wrap.querySelector(`[data-field="${f}"]`); if (i) o[f] = i.value || ''; });
            data.restaurant = o;
          }
        });
      }
      if (COOLDOWN_SECTION_IDS.includes(sectionId)) { const v = readSectionCooldown(sectionId); if (v !== undefined) data.cooldownSeconds = v; }
      return data;
    }
    function renderSectionListRows(sectionId, listKey, itemIsString, columns, defaultItem, slotsAsString, arr, htmlEditor) {
      const fragment = document.createDocumentFragment();
      (arr || []).forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const isStr = itemIsString;
        const val = isStr ? (typeof item === 'string' ? item : '') : item;
        columns.forEach(col => {
          const td = document.createElement('td');
          if (col.type === 'checkbox') {
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.dataset.col = col.key;
            cb.checked = isStr ? false : (val[col.key] === true);
            cb.addEventListener('change', () => {
              sectionData[sectionId] = sectionData[sectionId] || {};
              let arr = sectionData[sectionId][listKey];
              if (!Array.isArray(arr)) arr = [];
              sectionData[sectionId][listKey] = arr;
              arr[i] = arr[i] || {}; arr[i][col.key] = cb.checked;
              if (typeof markUnsaved === 'function') markUnsaved();
            });
            td.appendChild(cb);
          } else if (col.type === 'select' && col.options) {
            const sel = document.createElement('select');
            sel.dataset.col = col.key;
            (col.options || []).forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt.replace(/_/g, ' ');
              if (val[col.key] === opt) o.selected = true;
              sel.appendChild(o);
            });
            sel.addEventListener('change', () => {
              sectionData[sectionId] = sectionData[sectionId] || {};
              let a = sectionData[sectionId][listKey];
              if (!Array.isArray(a)) a = [];
              sectionData[sectionId][listKey] = a;
              a[i] = a[i] || {}; a[i][col.key] = sel.value;
              if (typeof markUnsaved === 'function') markUnsaved();
            });
            td.appendChild(sel);
          } else if ((col.type === 'image' || col.type === 'video') && !isStr) {
            const wrap = document.createElement('div');
            wrap.style.display = 'flex';
            wrap.style.alignItems = 'center';
            wrap.style.gap = '8px';
            const pathSpan = document.createElement('span');
            pathSpan.className = 'section-file-path';
            pathSpan.dataset.col = col.key;
            pathSpan.style.fontSize = '0.8rem';
            pathSpan.style.color = 'var(--muted)';
            pathSpan.textContent = val[col.key] ? (val[col.key] + '').replace(/^.*[/\\]/, '') : '—';
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = col.type === 'video' ? 'video/*' : 'image/*';
            fileInput.style.width = 'auto';
            fileInput.addEventListener('change', async () => {
              if (!selectedTeam || !fileInput.files?.length) return;
              const fd = new FormData();
              fd.append('file', fileInput.files[0]);
              fd.append('kind', col.type === 'video' ? 'video' : 'image');
              if (sectionId === 'stretching' && col.type === 'video') fd.append('section', 'stretching');
              try {
                const res = await fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.path) {
                  sectionData[sectionId] = sectionData[sectionId] || {};
                  let a = sectionData[sectionId][listKey];
                  if (!Array.isArray(a)) a = [];
                  sectionData[sectionId][listKey] = a;
                  a[i] = a[i] || {}; a[i][col.key] = data.path;
                  pathSpan.textContent = (data.path + '').replace(/^.*[/\\]/, '');
                  if (typeof markUnsaved === 'function') markUnsaved();
                }
              } catch (e) {}
              fileInput.value = '';
            });
            wrap.appendChild(fileInput);
            wrap.appendChild(pathSpan);
            td.appendChild(wrap);
          } else if (col.type === 'time' && !isStr) {
            const input = document.createElement('input');
            input.type = 'time';
            input.dataset.col = col.key;
            const raw = val[col.key] != null ? String(val[col.key]).trim() : '';
            input.value = raw ? raw.slice(0, 5) : '';
            input.addEventListener('input', () => {
              sectionData[sectionId] = sectionData[sectionId] || {};
              let a = sectionData[sectionId][listKey];
              if (!Array.isArray(a)) a = [];
              sectionData[sectionId][listKey] = a;
              a[i] = a[i] || {}; a[i][col.key] = input.value;
              if (typeof markUnsaved === 'function') markUnsaved();
            });
            td.appendChild(input);
          } else if (isStr && htmlEditor) {
            const toolbar = document.createElement('div');
            toolbar.style.marginBottom = '4px';
            const boldBtn = document.createElement('button');
            boldBtn.type = 'button';
            boldBtn.className = 'small';
            boldBtn.textContent = 'Bold';
            boldBtn.style.marginRight = '6px';
            boldBtn.addEventListener('click', () => { document.execCommand('bold', false); });
            const colorInput = document.createElement('input');
            colorInput.type = 'color';
            colorInput.title = 'Culoare text';
            colorInput.style.width = '28px';
            colorInput.style.height = '24px';
            colorInput.style.padding = '0';
            colorInput.style.border = 'none';
            colorInput.addEventListener('input', () => { document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, colorInput.value); });
            toolbar.appendChild(boldBtn);
            toolbar.appendChild(colorInput);
            const ed = document.createElement('div');
            ed.contentEditable = 'true';
            ed.dataset.htmlEditor = 'true';
            ed.dataset.col = 'text';
            ed.style.minHeight = '44px';
            ed.style.padding = '8px';
            ed.style.background = '#2d323c';
            ed.style.borderRadius = '6px';
            ed.style.fontSize = '0.9rem';
            ed.innerHTML = (typeof val === 'string' && val) ? val : '';
            ed.addEventListener('input', () => {
              sectionData[sectionId] = sectionData[sectionId] || {};
              let a = sectionData[sectionId][listKey];
              if (!Array.isArray(a)) a = [];
              sectionData[sectionId][listKey] = a;
              a[i] = ed.innerHTML;
              if (typeof markUnsaved === 'function') markUnsaved();
            });
            td.appendChild(toolbar);
            td.appendChild(ed);
          } else {
            const input = document.createElement('input');
            input.dataset.col = col.key;
            if (isStr) input.value = val;
            else if (col.key === 'slots' && slotsAsString && Array.isArray(val[col.key])) input.value = (val[col.key] || []).join(', ');
            else input.value = val[col.key] != null ? val[col.key] : '';
            input.addEventListener('input', () => {
              sectionData[sectionId] = sectionData[sectionId] || {};
              let arr = sectionData[sectionId][listKey];
              if (!Array.isArray(arr)) arr = [];
              sectionData[sectionId][listKey] = arr;
              if (isStr) arr[i] = input.value;
              else { arr[i] = arr[i] || {}; arr[i][col.key] = input.value; }
              if (typeof markUnsaved === 'function') markUnsaved();
            });
            td.appendChild(input);
          }
          tr.appendChild(td);
        });
        const act = document.createElement('td');
        act.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => {
          sectionData[sectionId] = sectionData[sectionId] || {};
          const arr = sectionData[sectionId][listKey] || [];
          arr.splice(i, 1);
          sectionData[sectionId][listKey] = arr;
          if (typeof markUnsaved === 'function') markUnsaved();
          renderSectionCardBody(sectionId);
        });
        act.appendChild(delBtn);
        tr.appendChild(act);
        fragment.appendChild(tr);
      });
      return fragment;
    }
    function renderAnniversaryEditor(sectionId, body) {
      const data = sectionData[sectionId] || SECTION_DEFAULTS[sectionId] || {};
      const people = Array.isArray(data.people) ? data.people : [];
      const employeeOfMonth = Array.isArray(data.employeeOfMonth) ? data.employeeOfMonth : [];
      const jobOpenings = Array.isArray(data.jobOpenings) ? data.jobOpenings : [];
      const events = Array.isArray(data.events) ? data.events : [];
      body.innerHTML = '';
      appendCooldownRow(body, sectionId);
      const sub = (title, tableHeaders, rows, addLabel, listKey, defaultItem, rowRenderer, collapsible) => {
        const wrap = document.createElement('div');
        wrap.className = 'section-anniversary-block' + (collapsible ? ' section-anniversary-collapsible collapsed' : '');
        wrap.style.marginBottom = '18px';
        const headerDiv = document.createElement('div');
        if (collapsible) {
          headerDiv.className = 'section-anniversary-collapsible-header';
          const toggleSpan = document.createElement('span');
          toggleSpan.className = 'toggle-icon';
          toggleSpan.textContent = '\u25B6';
          toggleSpan.setAttribute('aria-hidden', 'true');
          headerDiv.appendChild(toggleSpan);
          headerDiv.appendChild(document.createTextNode(title));
          headerDiv.addEventListener('click', () => {
            wrap.classList.toggle('collapsed');
            toggleSpan.textContent = wrap.classList.contains('collapsed') ? '\u25B6' : '\u25BC';
          });
        } else {
          headerDiv.className = 'section-subtitle';
          headerDiv.style.cssText = 'font-weight:600; margin-bottom:8px;';
          headerDiv.textContent = title;
        }
        wrap.appendChild(headerDiv);
        const contentWrap = document.createElement('div');
        if (collapsible) contentWrap.className = 'section-anniversary-collapsible-content';
        const table = document.createElement('table');
        table.className = 'section-item-table';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr>' + tableHeaders.map(h => '<th>' + escapeHtml(h) + '</th>').join('') + '<th class="col-actions">Acțiuni</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        tbody.className = 'section-items-tbody';
        tbody.dataset.section = sectionId;
        tbody.dataset.list = listKey;
        rows.forEach((row, i) => rowRenderer(tbody, row, i, sectionId, listKey, defaultItem));
        table.appendChild(tbody);
        contentWrap.appendChild(table);
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'small';
        addBtn.style.marginTop = '6px';
        addBtn.textContent = addLabel;
        addBtn.addEventListener('click', () => {
          sectionData[sectionId] = sectionData[sectionId] || {};
          const arr = sectionData[sectionId][listKey] || [];
          arr.push(typeof defaultItem === 'object' ? { ...defaultItem } : defaultItem);
          sectionData[sectionId][listKey] = arr;
          if (typeof markUnsaved === 'function') markUnsaved();
          renderSectionCardBody(sectionId);
        });
        contentWrap.appendChild(addBtn);
        wrap.appendChild(contentWrap);
        body.appendChild(wrap);
      };
      sub('Oameni (nume, birthday, new colleague, work start date)', ['Nume', 'Birthday', 'New colleague', 'Work start date'], people, '+ Adaugă persoană', 'people', { name: '', birthday: '', newColleague: false, workStartDate: '' }, (tbody, p, i, sid, listKey, def) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const nameInp = document.createElement('input');
        nameInp.dataset.col = 'name';
        nameInp.value = p.name || '';
        nameInp.placeholder = 'Nume';
        const birthInp = document.createElement('input');
        birthInp.type = 'date';
        birthInp.dataset.col = 'birthday';
        birthInp.value = (p.birthday || '').toString().slice(0, 10);
        const newColInp = document.createElement('input');
        newColInp.type = 'checkbox';
        newColInp.dataset.col = 'newColleague';
        newColInp.checked = !!p.newColleague;
        const workInp = document.createElement('input');
        workInp.type = 'date';
        workInp.dataset.col = 'workStartDate';
        workInp.value = (p.workStartDate || '').toString().slice(0, 10);
        [nameInp, birthInp, newColInp, workInp].forEach((el) => {
          const td = document.createElement('td');
          if (el.type === 'checkbox') {
            td.appendChild(el);
            el.addEventListener('change', () => { sectionData[sid] = sectionData[sid] || {}; sectionData[sid][listKey] = sectionData[sid][listKey] || []; sectionData[sid][listKey][i] = sectionData[sid][listKey][i] || {}; sectionData[sid][listKey][i][el.dataset.col] = el.checked; if (typeof markUnsaved === 'function') markUnsaved(); });
          } else {
            td.appendChild(el);
            el.addEventListener('input', () => { sectionData[sid] = sectionData[sid] || {}; sectionData[sid][listKey] = sectionData[sid][listKey] || []; sectionData[sid][listKey][i] = sectionData[sid][listKey][i] || {}; sectionData[sid][listKey][i][el.dataset.col] = el.value; if (typeof markUnsaved === 'function') markUnsaved(); });
          }
          tr.appendChild(td);
        });
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sid][listKey].splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      const eomWrap = document.createElement('div');
      eomWrap.className = 'section-anniversary-block section-anniversary-collapsible collapsed';
      eomWrap.style.marginBottom = '18px';
      const eomHeader = document.createElement('div');
      eomHeader.className = 'section-anniversary-collapsible-header';
      const eomToggle = document.createElement('span');
      eomToggle.className = 'toggle-icon';
      eomToggle.textContent = '\u25B6';
      eomToggle.setAttribute('aria-hidden', 'true');
      eomHeader.appendChild(eomToggle);
      eomHeader.appendChild(document.createTextNode('Employee of the month (max 3 din lista de oameni)'));
      eomHeader.addEventListener('click', () => {
        eomWrap.classList.toggle('collapsed');
        eomToggle.textContent = eomWrap.classList.contains('collapsed') ? '\u25B6' : '\u25BC';
      });
      eomWrap.appendChild(eomHeader);
      const eomContent = document.createElement('div');
      eomContent.className = 'section-anniversary-collapsible-content';
      const eomTable = document.createElement('table');
      eomTable.className = 'section-item-table';
      eomTable.innerHTML = '<thead><tr><th>Selectează persoană</th><th class="col-actions">Acțiuni</th></tr></thead><tbody class="section-items-tbody" data-section="' + sectionId + '" data-list="employeeOfMonth"></tbody>';
      const eomTbody = eomTable.querySelector('tbody');
      employeeOfMonth.forEach((name, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const td = document.createElement('td');
        const sel = document.createElement('select');
        sel.dataset.col = 'name';
        sel.innerHTML = '<option value="">— alege —</option>' + people.map(pp => '<option value="' + escapeHtml(pp.name || '') + '"' + (pp.name === name ? ' selected' : '') + '>' + escapeHtml(pp.name || '(fără nume)') + '</option>').join('');
        sel.addEventListener('change', () => { sectionData[sectionId].employeeOfMonth[i] = sel.value; if (typeof markUnsaved === 'function') markUnsaved(); });
        td.appendChild(sel);
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sectionId].employeeOfMonth.splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(td);
        tr.appendChild(actTd);
        eomTbody.appendChild(tr);
      });
      eomContent.appendChild(eomTable);
      const eomAdd = document.createElement('button');
      eomAdd.type = 'button';
      eomAdd.className = 'small';
      eomAdd.style.marginTop = '6px';
      eomAdd.textContent = '+ Adaugă (max 3)';
      eomAdd.disabled = employeeOfMonth.length >= 3;
      eomAdd.addEventListener('click', () => { sectionData[sectionId].employeeOfMonth = sectionData[sectionId].employeeOfMonth || []; if (sectionData[sectionId].employeeOfMonth.length < 3) sectionData[sectionId].employeeOfMonth.push(''); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
      eomContent.appendChild(eomAdd);
      eomWrap.appendChild(eomContent);
      body.appendChild(eomWrap);
      sub('Job openings', ['Titlu', 'Echipă'], jobOpenings, '+ Adaugă job', 'jobOpenings', { title: '', team: '' }, (tbody, j, i, sid, listKey, def) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        ['title', 'team'].forEach(key => {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.dataset.col = key;
          inp.value = j[key] || '';
          inp.placeholder = key === 'title' ? 'Titlu' : 'Echipă';
          inp.addEventListener('input', () => { sectionData[sid][listKey][i] = sectionData[sid][listKey][i] || {}; sectionData[sid][listKey][i][key] = inp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
          td.appendChild(inp);
          tr.appendChild(td);
        });
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sid][listKey].splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      sub('Events', ['Nume eveniment', 'Data', 'Ora'], events, '+ Adaugă eveniment', 'events', { name: '', date: '', time: '' }, (tbody, ev, i, sid, listKey, def) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const nameTd = document.createElement('td');
        const nameInp = document.createElement('input');
        nameInp.dataset.col = 'name';
        nameInp.value = ev.name || '';
        nameInp.placeholder = 'Nume eveniment';
        nameInp.addEventListener('input', () => { sectionData[sid][listKey][i] = sectionData[sid][listKey][i] || {}; sectionData[sid][listKey][i].name = nameInp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
        nameTd.appendChild(nameInp);
        const dateTd = document.createElement('td');
        const dateInp = document.createElement('input');
        dateInp.type = 'date';
        dateInp.dataset.col = 'date';
        dateInp.value = (ev.date || '').toString().slice(0, 10);
        dateInp.addEventListener('input', () => { sectionData[sid][listKey][i] = sectionData[sid][listKey][i] || {}; sectionData[sid][listKey][i].date = dateInp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
        dateTd.appendChild(dateInp);
        const timeTd = document.createElement('td');
        const timeInp = document.createElement('input');
        timeInp.type = 'time';
        timeInp.dataset.col = 'time';
        timeInp.value = (ev.time || '').toString().slice(0, 5);
        timeInp.addEventListener('input', () => { sectionData[sid][listKey][i] = sectionData[sid][listKey][i] || {}; sectionData[sid][listKey][i].time = timeInp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
        timeTd.appendChild(timeInp);
        tr.appendChild(nameTd);
        tr.appendChild(dateTd);
        tr.appendChild(timeTd);
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sid][listKey].splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      const exampleBtn = document.createElement('button');
      exampleBtn.type = 'button';
      exampleBtn.className = 'small';
      exampleBtn.style.marginTop = '12px';
      exampleBtn.style.marginRight = '8px';
      exampleBtn.textContent = 'Load example';
      exampleBtn.addEventListener('click', () => {
        const def = SECTION_DEFAULTS.anniversary;
        if (def) { sectionData[sectionId] = JSON.parse(JSON.stringify(def)); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); showMsg('Exemple încărcate. Salvează secțiunea pentru a le scrie pe server.', true); }
      });
      body.appendChild(exampleBtn);
      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'small';
      saveBtn.style.marginTop = '12px';
      saveBtn.textContent = 'Salvează secțiune';
      saveBtn.dataset.section = sectionId;
      saveBtn.addEventListener('click', async () => {
        if (!selectedTeam) { showMsg('Selectați o echipă.', false); return; }
        const json = buildSectionJsonFromUI(sectionId);
        const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/section/' + encodeURIComponent(sectionId), { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(json) });
        if (res.error) showMsg(res.error, false);
        else { sectionData[sectionId] = json; showMsg('Secțiune Anniversary salvată.', true); setChangeStatus('saved_unpushed'); }
      });
      body.appendChild(saveBtn);
    }
    function renderInfoSectionEditor(sectionId, body) {
      const data = sectionData[sectionId] || SECTION_DEFAULTS[sectionId] || {};
      const customerFeedback = Array.isArray(data.customerFeedback) ? data.customerFeedback : [];
      const quotesOfDay = Array.isArray(data.quotesOfDay) ? data.quotesOfDay : [];
      const didYouKnow = Array.isArray(data.didYouKnow) ? data.didYouKnow : [];
      const wordOfDay = Array.isArray(data.wordOfDay) ? data.wordOfDay : [];
      const reminderHealthy = Array.isArray(data.reminderHealthy) ? data.reminderHealthy : [];
      body.innerHTML = '';
      appendCooldownRow(body, sectionId);
      function addBlock(title, listKey, columns, rows, defaultItem, rowRenderer, collapsible) {
        const wrap = document.createElement('div');
        wrap.className = 'section-anniversary-block' + (collapsible ? ' section-anniversary-collapsible collapsed' : '');
        wrap.style.marginBottom = '18px';
        const headerDiv = document.createElement('div');
        if (collapsible) {
          headerDiv.className = 'section-anniversary-collapsible-header';
          const toggleSpan = document.createElement('span');
          toggleSpan.className = 'toggle-icon';
          toggleSpan.textContent = '\u25B6';
          toggleSpan.setAttribute('aria-hidden', 'true');
          headerDiv.appendChild(toggleSpan);
          headerDiv.appendChild(document.createTextNode(title));
          headerDiv.addEventListener('click', () => {
            wrap.classList.toggle('collapsed');
            toggleSpan.textContent = wrap.classList.contains('collapsed') ? '\u25B6' : '\u25BC';
          });
        } else {
          headerDiv.className = 'section-subtitle';
          headerDiv.style.cssText = 'font-weight:600; margin-bottom:8px;';
          headerDiv.textContent = title;
        }
        wrap.appendChild(headerDiv);
        const contentWrap = document.createElement('div');
        if (collapsible) contentWrap.className = 'section-anniversary-collapsible-content';
        const table = document.createElement('table');
        table.className = 'section-item-table';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr>' + columns.map(h => '<th>' + escapeHtml(h) + '</th>').join('') + '<th class="col-actions">Acțiuni</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        tbody.className = 'section-items-tbody';
        tbody.dataset.section = sectionId;
        tbody.dataset.list = listKey;
        rows.forEach((row, i) => rowRenderer(tbody, row, i));
        table.appendChild(tbody);
        contentWrap.appendChild(table);
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'small';
        addBtn.style.marginTop = '6px';
        addBtn.textContent = '+ Adaugă';
        addBtn.addEventListener('click', () => {
          sectionData[sectionId] = sectionData[sectionId] || {};
          const arr = sectionData[sectionId][listKey] || [];
          arr.push(typeof defaultItem === 'object' ? { ...defaultItem } : defaultItem);
          sectionData[sectionId][listKey] = arr;
          if (typeof markUnsaved === 'function') markUnsaved();
          renderSectionCardBody(sectionId);
        });
        contentWrap.appendChild(addBtn);
        wrap.appendChild(contentWrap);
        body.appendChild(wrap);
      }
      addBlock('Customer Feedback (nume client, quote)', 'customerFeedback', ['Nume client', 'Quote'], customerFeedback, { client: '', quote: '' }, (tbody, item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        ['client', 'quote'].forEach(key => {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.dataset.col = key;
          inp.value = item[key] || '';
          inp.placeholder = key === 'client' ? 'Nume client' : 'Quote';
          inp.addEventListener('input', () => { sectionData[sectionId].customerFeedback[i] = sectionData[sectionId].customerFeedback[i] || {}; sectionData[sectionId].customerFeedback[i][key] = inp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
          td.appendChild(inp);
          tr.appendChild(td);
        });
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sectionId].customerFeedback.splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      addBlock('Quotes of Day (quote + bifa Used; afișare 1/zi din lista cu Used)', 'quotesOfDay', ['Quote', 'Used'], quotesOfDay, { quote: '', used: false }, (tbody, item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const raw = (item && typeof item === 'object') ? item : { quote: typeof item === 'string' ? item : '', used: false };
        const quoteTd = document.createElement('td');
        const quoteInp = document.createElement('input');
        quoteInp.dataset.col = 'quote';
        quoteInp.value = raw.quote || '';
        quoteInp.placeholder = 'Quote';
        quoteInp.addEventListener('input', () => { sectionData[sectionId].quotesOfDay[i] = sectionData[sectionId].quotesOfDay[i] || {}; sectionData[sectionId].quotesOfDay[i].quote = quoteInp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
        quoteTd.appendChild(quoteInp);
        const usedTd = document.createElement('td');
        const usedCb = document.createElement('input');
        usedCb.type = 'checkbox';
        usedCb.dataset.col = 'used';
        usedCb.checked = !!raw.used;
        usedCb.addEventListener('change', () => { sectionData[sectionId].quotesOfDay[i] = sectionData[sectionId].quotesOfDay[i] || {}; sectionData[sectionId].quotesOfDay[i].used = usedCb.checked; if (typeof markUnsaved === 'function') markUnsaved(); });
        usedTd.appendChild(usedCb);
        tr.appendChild(quoteTd);
        tr.appendChild(usedTd);
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sectionId].quotesOfDay.splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      addBlock('Did you know (facts; afișare random 1/zi)', 'didYouKnow', ['Fact'], didYouKnow, { fact: '' }, (tbody, item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const td = document.createElement('td');
        const inp = document.createElement('input');
        inp.dataset.col = 'fact';
        inp.value = (item && item.fact) || (typeof item === 'string' ? item : '');
        inp.placeholder = 'Fact';
        inp.addEventListener('input', () => { sectionData[sectionId].didYouKnow[i] = sectionData[sectionId].didYouKnow[i] || {}; sectionData[sectionId].didYouKnow[i].fact = inp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
        td.appendChild(inp);
        tr.appendChild(td);
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sectionId].didYouKnow.splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      addBlock('Word of day (word, meaning; afișare random 1/zi)', 'wordOfDay', ['Word', 'Meaning'], wordOfDay, { word: '', meaning: '' }, (tbody, item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        ['word', 'meaning'].forEach(key => {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.dataset.col = key;
          inp.value = item[key] || '';
          inp.placeholder = key === 'word' ? 'Word' : 'Meaning';
          inp.addEventListener('input', () => { sectionData[sectionId].wordOfDay[i] = sectionData[sectionId].wordOfDay[i] || {}; sectionData[sectionId].wordOfDay[i][key] = inp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
          td.appendChild(inp);
          tr.appendChild(td);
        });
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sectionId].wordOfDay.splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      addBlock('Reminder healthy (titlu, text)', 'reminderHealthy', ['Titlu', 'Text'], reminderHealthy, { title: '', text: '' }, (tbody, item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        ['title', 'text'].forEach(key => {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.dataset.col = key;
          inp.value = item[key] || '';
          inp.placeholder = key === 'title' ? 'Titlu' : 'Text';
          inp.addEventListener('input', () => { sectionData[sectionId].reminderHealthy[i] = sectionData[sectionId].reminderHealthy[i] || {}; sectionData[sectionId].reminderHealthy[i][key] = inp.value; if (typeof markUnsaved === 'function') markUnsaved(); });
          td.appendChild(inp);
          tr.appendChild(td);
        });
        const actTd = document.createElement('td');
        actTd.className = 'col-actions';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'small danger';
        delBtn.textContent = 'Șterge';
        delBtn.addEventListener('click', () => { sectionData[sectionId].reminderHealthy.splice(i, 1); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); });
        actTd.appendChild(delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      }, true);
      const exampleBtn = document.createElement('button');
      exampleBtn.type = 'button';
      exampleBtn.className = 'small';
      exampleBtn.style.marginTop = '12px';
      exampleBtn.style.marginRight = '8px';
      exampleBtn.textContent = 'Load example';
      exampleBtn.addEventListener('click', () => {
        const def = SECTION_DEFAULTS.info_section;
        if (def) { sectionData[sectionId] = JSON.parse(JSON.stringify(def)); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); showMsg('Exemple încărcate. Salvează secțiunea pentru a le scrie pe server.', true); }
      });
      body.appendChild(exampleBtn);
      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'small';
      saveBtn.style.marginTop = '12px';
      saveBtn.textContent = 'Salvează secțiune';
      saveBtn.dataset.section = sectionId;
      saveBtn.addEventListener('click', async () => {
        if (!selectedTeam) { showMsg('Selectați o echipă.', false); return; }
        const json = buildSectionJsonFromUI(sectionId);
        const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/section/' + encodeURIComponent(sectionId), { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(json) });
        if (res.error) showMsg(res.error, false);
        else { sectionData[sectionId] = json; showMsg('Secțiune Info salvată.', true); setChangeStatus('saved_unpushed'); }
      });
      body.appendChild(saveBtn);
    }
    function renderSectionCardBody(sectionId) {
      const body = document.querySelector(`.section-card[data-section="${sectionId}"] .section-body`);
      if (!body) return;
      const schema = SECTION_SCHEMAS[sectionId];
      const data = sectionData[sectionId] || SECTION_DEFAULTS[sectionId] || {};
      if (schema?.customEditor) return;
      if (schema?.infoSectionEditor) {
        renderInfoSectionEditor(sectionId, body);
        return;
      }
      if (schema?.emptySection) {
        body.innerHTML = '<p class="section-empty-hint" style="color: var(--muted); margin-bottom: 12px;">Curățat pentru integrare ulterioară cu tool extern.</p>';
        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'small';
        saveBtn.textContent = 'Salvează secțiune (gol)';
        saveBtn.dataset.section = sectionId;
        saveBtn.addEventListener('click', async () => {
          if (!selectedTeam) { showMsg('Selectați o echipă.', false); return; }
          const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/section/' + encodeURIComponent(sectionId), { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: '{}' });
          if (res.error) showMsg(res.error, false);
          else { sectionData[sectionId] = {}; showMsg('Secțiune salvată.', true); setChangeStatus('saved_unpushed'); }
        });
        body.appendChild(saveBtn);
        return;
      }
      if (schema?.customAnniversary) {
        renderAnniversaryEditor(sectionId, body);
        return;
      }
      const lists = getSectionList(sectionId);
      body.innerHTML = '';
      if (COOLDOWN_SECTION_IDS.includes(sectionId)) appendCooldownRow(body, sectionId);
      if (schema?.originFixed) {
        const p = document.createElement('p');
        p.className = 'section-extra';
        p.style.cssText = 'color: var(--muted); font-size: 0.9rem; margin-bottom: 10px;';
        p.textContent = 'Plecare: ' + schema.originFixed;
        body.appendChild(p);
      }
      if (schema?.extraKeys && schema.extraKeys.includes('origin')) {
        const wrap = document.createElement('div');
        wrap.className = 'section-extra';
        wrap.dataset.section = sectionId;
        wrap.dataset.key = 'origin';
        const val = (data.origin || '');
        wrap.innerHTML = '<label>Origin (traffic)</label><input type="text" value="' + escapeHtml(val) + '" />';
        const originInput = wrap.querySelector('input');
        originInput.dataset.field = 'origin';
        originInput.addEventListener('input', () => { if (typeof markUnsaved === 'function') markUnsaved(); });
        body.appendChild(wrap);
      }
      if (schema?.extraKeys && schema.extraKeys.includes('restaurant')) {
        const wrap = document.createElement('div');
        wrap.className = 'section-extra section-object-fields';
        wrap.dataset.section = sectionId;
        wrap.dataset.key = 'restaurant';
        const r = data.restaurant || {};
        wrap.innerHTML = '<label>Restaurant name</label><input type="text" data-field="name" value="' + escapeHtml(r.name || '') + '" /><label>Info restaurant</label><input type="text" data-field="tagline" value="' + escapeHtml(r.tagline || '') + '" placeholder="Tagline / descriere" />';
        wrap.querySelectorAll('input').forEach(inp => inp.addEventListener('input', () => { if (typeof markUnsaved === 'function') markUnsaved(); }));
        body.appendChild(wrap);
      }
      lists.forEach(({ listKey, itemIsString, columns, defaultItem, slotsAsString, arr }) => {
        const sub = document.createElement('div');
        if (schema?.lists) sub.innerHTML = '<div class="section-subtitle">' + (listKey === 'messages' ? 'Mesaje' : 'Oameni') + '</div>';
        const table = document.createElement('table');
        table.className = 'section-item-table';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr>' + columns.map(c => '<th>' + escapeHtml(c.label) + '</th>').join('') + '<th class="col-actions">Acțiuni</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        tbody.className = 'section-items-tbody';
        tbody.dataset.section = sectionId;
        tbody.dataset.list = listKey;
        tbody.appendChild(renderSectionListRows(sectionId, listKey, itemIsString, columns, defaultItem, slotsAsString, arr, schema?.htmlEditor));
        table.appendChild(tbody);
        sub.appendChild(table);
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'small';
        addBtn.style.marginTop = '6px';
        addBtn.textContent = '+ Adaugă';
        const maxItems = schema?.maxItems;
        const singleItem = schema?.singleItem;
        addBtn.disabled = !!(maxItems && arr.length >= maxItems) || !!(singleItem && arr.length >= 1);
        addBtn.addEventListener('click', () => {
          sectionData[sectionId] = sectionData[sectionId] || {};
          const arr = sectionData[sectionId][listKey] || [];
          arr.push(typeof defaultItem === 'object' && defaultItem !== null ? { ...defaultItem } : defaultItem);
          sectionData[sectionId][listKey] = arr;
          if (typeof markUnsaved === 'function') markUnsaved();
          renderSectionCardBody(sectionId);
        });
        sub.appendChild(addBtn);
        body.appendChild(sub);
      });
      const exampleBtn = document.createElement('button');
      exampleBtn.type = 'button';
      exampleBtn.className = 'small';
      exampleBtn.style.marginTop = '12px';
      exampleBtn.style.marginRight = '8px';
      exampleBtn.textContent = 'Load example';
      exampleBtn.title = 'Încarcă exemplele din aplicația TV';
      exampleBtn.addEventListener('click', () => {
        const def = SECTION_DEFAULTS[sectionId];
        if (def) { sectionData[sectionId] = JSON.parse(JSON.stringify(def)); if (typeof markUnsaved === 'function') markUnsaved(); renderSectionCardBody(sectionId); showMsg('Exemple încărcate. Salvează secțiunea pentru a le scrie pe server.', true); }
      });
      body.appendChild(exampleBtn);
      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'small';
      saveBtn.style.marginTop = '12px';
      saveBtn.textContent = 'Salvează secțiune';
      saveBtn.dataset.section = sectionId;
      saveBtn.addEventListener('click', async () => {
        if (!selectedTeam) { showMsg('Selectați o echipă.', false); return; }
        const json = buildSectionJsonFromUI(sectionId);
        const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/section/' + encodeURIComponent(sectionId), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(json)
        });
        if (res.error) showMsg(res.error, false);
        else { sectionData[sectionId] = json; showMsg('Secțiune ' + SECTION_LABELS[sectionId] + ' salvată.', true); setChangeStatus('saved_unpushed'); }
      });
      body.appendChild(saveBtn);
    }
    function renderSectionCards() {
      const container = document.getElementById('sectionCards');
      if (!container) return;
      const sections = Object.keys(SECTION_LABELS);
      container.innerHTML = sections.map(id => {
        const schema = SECTION_SCHEMAS[id];
        const isCustom = schema?.customEditor;
        return `
        <div class="section-card collapsed" data-section="${escapeHtml(id)}" id="sectionCard-${escapeHtml(id)}">
          <div class="section-header">
            <span>${escapeHtml(SECTION_LABELS[id])}</span>
            <span class="section-toggle">▶</span>
          </div>
          <div class="section-body">
            ${isCustom ? `<textarea class="section-content" data-section="${escapeHtml(id)}" placeholder="JSON"></textarea>
            <div class="section-actions">
              <button type="button" class="small" data-section="${escapeHtml(id)}" data-action="example">Load example</button>
              <button type="button" class="small" data-section="${escapeHtml(id)}" data-action="save">Save</button>
            </div>` : ''}
          </div>
        </div>`;
      }).join('');
      container.querySelectorAll('.section-card').forEach(card => {
        const header = card.querySelector('.section-header');
        const id = card.dataset.section;
        header.addEventListener('click', () => {
          card.classList.toggle('collapsed');
          card.querySelector('.section-toggle').textContent = card.classList.contains('collapsed') ? '▶' : '▼';
        });
        if (!SECTION_SCHEMAS[id]?.customEditor) renderSectionCardBody(id);
      });
      container.querySelectorAll('[data-action="example"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.section;
          const ex = SECTION_DEFAULTS[id];
          const ta = document.querySelector(`.section-content[data-section="${id}"]`);
          if (ta && ex) ta.value = JSON.stringify(ex, null, 2);
        });
      });
      container.querySelectorAll('[data-action="save"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!selectedTeam) { showMsg('Selectați o echipă.', false); return; }
          const id = btn.dataset.section;
          const ta = document.querySelector(`.section-content[data-section="${id}"]`);
          if (!ta) return;
          let data;
          try {
            data = JSON.parse(ta.value || '{}');
          } catch (e) {
            showMsg('JSON invalid: ' + e.message, false);
            return;
          }
          const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/section/' + encodeURIComponent(id), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.error) showMsg(res.error, false);
          else { sectionData[id] = data; showMsg('Secțiune ' + SECTION_LABELS[id] + ' salvată.', true); setChangeStatus('saved_unpushed'); }
        });
      });
      container.querySelectorAll('.section-content').forEach(ta => {
        ta.addEventListener('input', () => { if (typeof markUnsaved === 'function') markUnsaved(); });
      });
    }

    async function loadSectionContents() {
      if (!selectedTeam) return;
      try {
        await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/ensure-section-dirs', { method: 'POST' });
      } catch (e) {}
      const sections = Object.keys(SECTION_LABELS);
      for (const id of sections) {
        try {
          const data = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/section/' + encodeURIComponent(id));
          const content = (data && typeof data === 'object' && !data.error) ? data : (SECTION_DEFAULTS[id] || {});
          sectionData[id] = content;
          const ta = document.querySelector(`.section-content[data-section="${id}"]`);
          if (ta) ta.value = JSON.stringify(content, null, 2);
          else renderSectionCardBody(id);
        } catch (e) {
          sectionData[id] = SECTION_DEFAULTS[id] || {};
          const ta = document.querySelector(`.section-content[data-section="${id}"]`);
          if (ta) ta.value = '';
          else renderSectionCardBody(id);
        }
      }
    }

    async function deleteTeam(name) {
      if (!gitConnected) return;
      if (!confirm('Ștergi echipa "' + name + '" și tot conținutul?')) return;
      const res = await api('/api/teams/' + encodeURIComponent(name), { method: 'DELETE' });
      if (res.error) { showMsg(res.error, false); return; }
      showMsg('Echipă ștearsă.');
      if (selectedTeam === name) loadPlaylist(null);
      loadTeams();
    }

    document.getElementById('formTeam').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!gitConnected) return;
      const name = document.getElementById('teamName').value.trim();
      if (!name) return;
      const res = await api('/api/teams', { method: 'POST', body: JSON.stringify({ name }), headers: { 'Content-Type': 'application/json' } });
      if (res.error) { showMsg(res.error, false); return; }
      showMsg('Echipă creată: ' + (res.name || name));
      document.getElementById('teamName').value = '';
      loadTeams();
    });

    async function loadPlaylist(team) {
      selectedTeam = team;
      document.getElementById('currentTeam').textContent = team || '(selectează o echipă)';
      const sectionsTeamEl = document.getElementById('sectionsTeamName');
      if (sectionsTeamEl) sectionsTeamEl.textContent = team ? ' – ' + team : '';
      document.querySelectorAll('#teamList li').forEach(li => {
        li.classList.toggle('active', li.dataset.name === team);
      });
      if (!team) {
        slides = [];
        renderSlides();
        setButtons(false);
        setChangeStatus('up_to_date');
        sectionData = {};
        Object.keys(SECTION_LABELS || {}).forEach(id => {
          const ta = document.querySelector('.section-content[data-section="' + id + '"]');
          if (ta) ta.value = '';
          else if (typeof renderSectionCardBody === 'function') renderSectionCardBody(id);
        });
        return;
      }
      setButtons(true);
      const data = await api('/api/teams/' + encodeURIComponent(team) + '/playlist');
      slides = Array.isArray(data.slides) ? data.slides.map(s => ({ ...s, enabled: s.enabled !== false })) : [];
      renderSlides();
      setChangeStatus('up_to_date');
      loadSectionContents();
    }

    function setButtons(enabled) {
      document.getElementById('addSlide').disabled = !enabled;
      document.getElementById('savePlaylist').disabled = !enabled;
    }

    function isTypeLocked(slide) {
      const t = (slide.type || '').toLowerCase();
      if (FILE_TYPES.includes(t)) return !!slide.src;
      if (URL_TYPES.includes(t) || DOC_TYPES.includes(t)) return !!slide.src;
      return false;
    }
    function isSrcLocked(slide) {
      const t = (slide.type || '').toLowerCase();
      if (FILE_TYPES.includes(t) && slide.src) return true;
      if (DOC_TYPES.includes(t) && slide.src) return true;
      return false;
    }

    function isDocType(slide) {
      const t = (slide.type || '').toLowerCase();
      return DOC_TYPES.includes(t) || (t === 'web_url' && slide.converted);
    }
    function actionButton(slide, i) {
      const t = (slide.type || '').toLowerCase();
      if (t === 'web_url' && slide.converted) return '<span class="converted-label">Converted</span>';
      if (slide.src) {
        if (FILE_TYPES.includes(t) || URL_TYPES.includes(t)) return '';
        if (DOC_TYPES.includes(t) && slide.converted) return '<span class="converted-label">Converted</span>';
      }
      if (t === 'image') return '<button type="button" class="small btn-upload" data-i="'+i+'" data-kind="image">Upload</button>';
      if (t === 'video') return '<button type="button" class="small btn-upload" data-i="'+i+'" data-kind="video">Upload</button>';
      if (DOC_TYPES.includes(t)) {
        if (slide.converted) return '<span class="converted-label">Converted</span>';
        return '<button type="button" class="small btn-upload btn-upload-doc" data-i="'+i+'">Upload</button><button type="button" class="small btn-convert" data-i="'+i+'">Convert</button>';
      }
      return '<button type="button" class="small btn-row-save" data-i="'+i+'">Salvează</button>';
    }
    function rangeCell(slide, i) {
      if (!isDocType(slide)) return '<span></span>';
      if (slide.converted || (slide.src && slide.type)) {
        const rangeVal = escapeHtml(slide.range||'all');
        const pageInfo = (slide.pageCount != null) ? ' ('+slide.pageCount+' pag.)' : '';
        return '<span class="range-readonly" data-i="'+i+'">'+rangeVal+pageInfo+'</span>';
      }
      return '<input type="text" class="range-input" data-i="'+i+'" placeholder="all, 1-5, 1,3,5" value="'+escapeHtml(slide.range||'')+'" />';
    }
    function soundCell(slide, i) {
      const t = (slide.type || '').toLowerCase();
      if (t === 'video') {
        const withSound = slide.videoSound === true;
        return '<select class="sound-cell" data-i="'+i+'" data-kind="video"><option value="yes"'+(withSound?' selected':'')+'>Yes</option><option value="no"'+(withSound?'':' selected')+'>No</option></select>';
      }
      if (t === 'vimeo') {
        const withSound = slide.vimeoSound === true;
        return '<select class="sound-cell" data-i="'+i+'" data-kind="vimeo"><option value="yes"'+(withSound?' selected':'')+'>Yes</option><option value="no"'+(withSound?'':' selected')+'>No</option></select>';
      }
      return '<span></span>';
    }
    function fillWidthCell(slide, i) {
      const t = (slide.type || '').toLowerCase();
      const hasFill = ['image', 'pdf', 'word', 'pptx', 'excel'].includes(t) || (t === 'web_url' && slide.converted);
      if (!hasFill) return '<span></span>';
      const fill = slide.fillWidth === true;
      return '<select class="fill-cell" data-i="'+i+'"><option value="yes"'+(fill?' selected':'')+'>Yes</option><option value="no"'+(fill?'':' selected')+'>No</option></select>';
    }

    function renderSlides() {
      const div = document.getElementById('slideList');
      div.innerHTML = slides.map((s, i) => {
        const typeLocked = isTypeLocked(s);
        const srcLocked = isSrcLocked(s);
        const typeVal = (s.type || 'web_url');
        const isDisabled = s.enabled === false;
        return `
        <div class="slide-row ${isDisabled ? 'disabled-row' : ''}" data-i="${i}">
          <select class="type" ${typeLocked ? 'disabled' : ''} data-i="${i}">${TYPES.map(t => '<option value="'+t+'"'+(typeVal===t?' selected':'')+'>'+t+'</option>').join('')}</select>
          <input type="text" class="src" value="${escapeHtml(s.src||'')}" placeholder="${srcLocked ? '' : 'URL sau cale'}" ${srcLocked ? 'readonly' : ''} data-i="${i}" />
          <input type="number" class="duration" value="${s.duration ?? 10}" min="1" data-i="${i}" title="${(DOC_TYPES.includes((s.type||'').toLowerCase()) || ((s.type||'').toLowerCase()==='web_url' && s.converted)) ? 'Secunde per pagină' : 'Secunde'}" />
          ${soundCell(s, i)}
          ${fillWidthCell(s, i)}
          <input type="text" class="title" value="${escapeHtml(s.title||'')}" placeholder="Titlu" data-i="${i}" />
          <input type="text" class="subtitle" value="${escapeHtml(s.subtitle||'')}" placeholder="Subtitlu" data-i="${i}" />
          ${rangeCell(s, i)}
          <button type="button" class="small btn-enable" data-i="${i}">Enable</button>
          <button type="button" class="small btn-disable" data-i="${i}">Disable</button>
          <span class="row-action">${actionButton(s, i)}</span>
          <button type="button" class="small danger btn-delete" data-i="${i}">Șterge</button>
        </div>
      `}).join('');

      div.querySelectorAll('.type').forEach(el => {
        const i = parseInt(el.dataset.i, 10);
        el.addEventListener('change', () => { slides[i].type = el.value; markUnsaved(); renderSlides(); });
      });
      div.querySelectorAll('.src, .duration, .title, .subtitle, .range-input').forEach(el => {
        const i = parseInt(el.dataset.i, 10);
        const cls = el.className.split(' ')[0];
        el.addEventListener('input', () => {
          const slide = slides[i];
          if (cls === 'duration') slide.duration = parseInt(el.value, 10) || 10;
          else if (cls === 'range-input') slide.range = el.value;
          else slide[cls] = el.value;
          markUnsaved();
        });
      });
      div.querySelectorAll('.sound-cell').forEach(el => {
        const i = parseInt(el.dataset.i, 10);
        const kind = el.dataset.kind;
        el.addEventListener('change', () => {
          const val = el.value === 'yes';
          if (kind === 'video') slides[i].videoSound = val;
          else if (kind === 'vimeo') slides[i].vimeoSound = val;
          markUnsaved();
        });
      });
      div.querySelectorAll('.fill-cell').forEach(el => {
        const i = parseInt(el.dataset.i, 10);
        el.addEventListener('change', () => {
          slides[i].fillWidth = el.value === 'yes';
          markUnsaved();
        });
      });
      div.querySelectorAll('.btn-upload').forEach(btn => {
        if (btn.classList.contains('btn-upload-doc'))
          btn.addEventListener('click', () => openUploadDocument(parseInt(btn.dataset.i, 10)));
        else
          btn.addEventListener('click', () => openUpload(parseInt(btn.dataset.i, 10), btn.dataset.kind));
      });
      div.querySelectorAll('.btn-convert').forEach(btn => {
        btn.addEventListener('click', () => doConvert(parseInt(btn.dataset.i, 10)));
      });
      div.querySelectorAll('.btn-row-save').forEach(btn => {
        btn.addEventListener('click', () => savePlaylistAndFeedback(parseInt(btn.dataset.i, 10)));
      });
      div.querySelectorAll('.btn-enable').forEach(btn => {
        btn.addEventListener('click', () => { slides[parseInt(btn.dataset.i, 10)].enabled = true; markUnsaved(); renderSlides(); });
      });
      div.querySelectorAll('.btn-disable').forEach(btn => {
        btn.addEventListener('click', () => { slides[parseInt(btn.dataset.i, 10)].enabled = false; markUnsaved(); renderSlides(); });
      });
      div.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => deleteSlide(parseInt(btn.dataset.i, 10)));
      });
    }

    let uploadInput = null;
    function openUpload(rowIndex, kind) {
      if (!gitConnected || !selectedTeam) return;
      if (!uploadInput) {
        uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.className = 'file-input-hidden';
        uploadInput.accept = kind === 'image' ? 'image/*' : 'video/*';
        document.body.appendChild(uploadInput);
      }
      uploadInput.accept = kind === 'image' ? 'image/*' : 'video/*';
      uploadInput.onchange = () => doUpload(rowIndex, kind, uploadInput.files[0]);
      uploadInput.click();
    }

    async function doUpload(rowIndex, kind, file) {
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('kind', kind);
      showMsg('Se încarcă...', true);
      const res = await fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok || data.error) {
        showMsg(data.error || 'Încărcare eșuată.', false);
        return;
      }
      const slide = slides[rowIndex];
      slide.type = kind;
      slide.src = data.path;
      if (!slide.id) slide.id = 'slide-' + Date.now();
      await savePlaylistSilent();
      setChangeStatus('saved_unpushed');
      renderSlides();
      showMsg('Fișier încărcat: ' + data.path, true);
    }

    let docUploadInput = null;
    function openUploadDocument(rowIndex) {
      if (!gitConnected || !selectedTeam) return;
      if (!docUploadInput) {
        docUploadInput = document.createElement('input');
        docUploadInput.type = 'file';
        docUploadInput.className = 'file-input-hidden';
        docUploadInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx';
        document.body.appendChild(docUploadInput);
      }
      docUploadInput.onchange = () => doUploadDocument(rowIndex, docUploadInput.files[0]);
      docUploadInput.click();
    }
    async function doUploadDocument(rowIndex, file) {
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      showMsg('Uploading document...', true);
      const res = await fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload-document', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok || data.error) {
        showMsg(data.error || 'Upload failed.', false);
        return;
      }
      const slide = slides[rowIndex];
      slide.src = data.path;
      const ext = (file.name || '').split('.').pop().toLowerCase();
      if (ext === 'pdf') slide.type = 'pdf';
      else if (['doc','docx'].includes(ext)) slide.type = 'word';
      else if (['xls','xlsx'].includes(ext)) slide.type = 'excel';
      else if (['ppt','pptx'].includes(ext)) slide.type = 'pptx';
      if (!slide.id) slide.id = 'slide-' + Date.now();
      await savePlaylistSilent();
      setChangeStatus('saved_unpushed');
      renderSlides();
      showMsg('Document uploaded. Set range and click Convert.', true);
    }

    async function deleteSlide(rowIndex) {
      if (!gitConnected || !selectedTeam) return;
      const slide = slides[rowIndex];
      const src = (slide.src || '').trim();
      const isLocal = /^(documents|photos|videos)\//.test(src);
      if (isLocal) {
        const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/delete-resource', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ src })
        });
        if (res.error) {
          showMsg(res.error, false);
          return;
        }
      }
      slides.splice(rowIndex, 1);
      await savePlaylistSilent();
      setChangeStatus('saved_unpushed');
      renderSlides();
      showMsg(isLocal ? 'Slide and resource deleted. Push changes to update git.' : 'Slide deleted.', true);
    }

    async function doConvert(rowIndex) {
      if (!gitConnected || !selectedTeam) return;
      const slide = slides[rowIndex];
      const src = (slide.src || '').trim();
      if (!src) {
        showMsg('Upload a document first.', false);
        return;
      }
      const range = (slide.range || 'all').trim() || 'all';
      setLoading(true, 'Converting...');
      let res;
      try {
        res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/convert-document', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ src, range })
        });
      } catch (e) {
        res = { error: 'Request failed.' };
      }
      setLoading(false);
      if (res.ok) {
        slides[rowIndex].converted = true;
        slides[rowIndex].pageCount = res.count;
        await savePlaylistSilent();
        setChangeStatus('saved_unpushed');
        showMsg('Converted ' + res.count + ' page(s). Duration is per image.', true);
        renderSlides();
      } else {
        showMsg(res.error || 'Convert failed.', false);
      }
    }

    async function savePlaylistSilent() {
      if (!selectedTeam) return;
      await fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/playlist', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slides })
      });
    }

    async function savePlaylistAndFeedback(rowIndex) {
      if (!gitConnected || !selectedTeam) return;
      const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/playlist', {
        method: 'PUT',
        body: JSON.stringify({ slides }),
        headers: { 'Content-Type': 'application/json' }
      });
      if (res.error) { showMsg(res.error, false); return; }
      setChangeStatus('saved_unpushed');
      showMsg('Playlist saved. Push changes for modifications to take effect.', true);
      renderSlides();
    }

    document.getElementById('addSlide').addEventListener('click', () => {
      if (!gitConnected || !selectedTeam) return;
      expandPlaylist();
      openAddSlideModal();
    });
    document.getElementById('savePlaylist').addEventListener('click', async () => {
      if (!gitConnected || !selectedTeam) return;
      const res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/playlist', {
        method: 'PUT',
        body: JSON.stringify({ slides }),
        headers: { 'Content-Type': 'application/json' }
      });
      if (res.error) { showMsg(res.error, false); return; }
      setChangeStatus('saved_unpushed');
      showMsg('Playlist saved. Push changes for modifications to take effect.', true);
    });

    document.getElementById('teamList').addEventListener('click', (e) => {
      if (!gitConnected) return;
      const li = e.target.closest('li');
      if (li && !e.target.matches('button')) {
        const name = li.dataset.name || li.querySelector('span').textContent;
        loadPlaylist(name);
      }
    });

    document.getElementById('playlistHeader').addEventListener('click', () => togglePlaylist());

    let modalFormValid = false;
    let modalSrc = null;
    let modalDocPath = null;
    let modalDocConverted = false;
    let modalConvertCount = null;
    let modalWebConverted = false;
    let modalWebPath = null;

    function openAddSlideModal() {
      document.getElementById('addSlideModal').classList.remove('hidden');
      modalFormValid = false;
      modalSrc = null;
      modalDocPath = null;
      modalDocConverted = false;
      modalConvertCount = null;
      modalWebConverted = false;
      modalWebPath = null;
      const videoSoundEl = document.getElementById('modalVideoSound');
      if (videoSoundEl) videoSoundEl.checked = false;
      const vimeoSoundEl = document.getElementById('modalVimeoSound');
      if (vimeoSoundEl) vimeoSoundEl.checked = false;
      ['modalImageFillWidth','modalPdfFillWidth','modalWordFillWidth','modalPptxFillWidth','modalExcelFillWidth','modalWebFillWidth'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = false;
      });
      document.getElementById('modalFormStatus').classList.add('hidden');
      document.getElementById('modalFinalizeBtn').disabled = true;
      document.getElementById('modalType').value = 'image';
      showModalPanel('image');
    }
    function closeAddSlideModal() {
      document.getElementById('addSlideModal').classList.add('hidden');
    }
    function showModalPanel(type) {
      document.querySelectorAll('#modalFormPanels .form-panel').forEach(p => {
        p.classList.toggle('visible', p.dataset.type === type);
      });
      modalFormValid = false;
      document.getElementById('modalFinalizeBtn').disabled = true;
    }
    function setModalStatus(msg, ok) {
      const el = document.getElementById('modalFormStatus');
      el.textContent = msg;
      el.className = 'form-status ' + (ok ? 'ok' : 'err');
      el.classList.remove('hidden');
    }
    function setModalValid(valid) {
      modalFormValid = valid;
      document.getElementById('modalFinalizeBtn').disabled = !valid;
    }

    document.getElementById('modalType').addEventListener('change', () => {
      showModalPanel(document.getElementById('modalType').value);
    });
    document.getElementById('modalCancelBtn').addEventListener('click', closeAddSlideModal);

    document.getElementById('modalImageUpload').addEventListener('click', () => {
      const input = document.getElementById('modalImageFile');
      if (!input.files.length) { setModalStatus('Selectați un fișier.', false); return; }
      const fd = new FormData();
      fd.append('file', input.files[0]);
      fd.append('kind', 'image');
      setModalStatus('Se încarcă...', true);
      fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.path) { modalSrc = data.path; setModalStatus('image încărcată: ' + data.path, true); }
          else { setModalStatus(data.error || 'Eroare', false); }
        })
        .catch(() => setModalStatus('Eroare la încărcare', false));
    });
    document.getElementById('modalImageValidateUrl').addEventListener('click', () => {
      const url = document.getElementById('modalImageUrl').value.trim();
      if (!url) { setModalStatus('Introduceți URL.', false); return; }
      const img = new Image();
      img.onload = () => { modalSrc = url; setModalStatus('URL imagine valid.', true); };
      img.onerror = () => setModalStatus('URL invalid sau imagine inaccesibilă.', false);
      img.src = url;
    });
    document.getElementById('modalVideoUpload').addEventListener('click', () => {
      const input = document.getElementById('modalVideoFile');
      if (!input.files.length) { setModalStatus('Selectați un fișier video.', false); return; }
      const fd = new FormData();
      fd.append('file', input.files[0]);
      fd.append('kind', 'video');
      setModalStatus('Se încarcă...', true);
      fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.path) { modalSrc = data.path; setModalStatus('Video încărcat: ' + data.path, true); }
          else { setModalStatus(data.error || 'Eroare', false); }
        })
        .catch(() => setModalStatus('Eroare la încărcare', false));
    });
    document.getElementById('modalVideoValidateUrl').addEventListener('click', () => {
      const url = document.getElementById('modalVideoUrl').value.trim();
      if (!url) { setModalStatus('Introduceți URL video.', false); return; }
      const v = document.createElement('video');
      v.oncanplay = () => { modalSrc = url; setModalStatus('URL video valid.', true); };
      v.onerror = () => setModalStatus('URL video invalid sau inaccesibil.', false);
      v.src = url;
    });
    document.getElementById('modalWebUrlValidate').addEventListener('click', () => {
      const url = document.getElementById('modalWebUrl').value.trim();
      if (!url) { setModalStatus('Introduceți URL.', false); return; }
      if (!url.startsWith('http')) { setModalStatus('URL trebuie să înceapă cu http.', false); return; }
      modalSrc = url;
      setModalStatus('URL salvat. Pentru Convert: apăsați Convert. Altfel validați și finalizați pentru iframe.', true);
    });
    document.getElementById('modalWebConvert').addEventListener('click', async () => {
      const url = document.getElementById('modalWebUrl').value.trim();
      if (!url || !url.startsWith('http')) { setModalStatus('Introduceți un URL valid și apăsați Validează URL.', false); return; }
      const range = document.getElementById('modalWebRange').value.trim() || 'all';
      setLoading(true, 'Capturând pagină...');
      let res;
      try {
        res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/convert-web', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url, range }) });
      } catch (e) { res = { ok: false }; }
      setLoading(false);
      if (res.ok) { modalWebConverted = true; modalWebPath = res.path; modalConvertCount = res.count; setModalStatus('Convertit ' + res.count + ' imagine(i). Validați form și finalizați.', true); }
      else { setModalStatus(res.error || 'Convert eșuat', false); }
    });
    document.getElementById('modalVimeoValidate').addEventListener('click', () => {
      const url = document.getElementById('modalVimeoUrl').value.trim();
      if (!url) { setModalStatus('Introduceți URL Vimeo.', false); return; }
      modalSrc = url;
      setModalStatus('URL salvat. Validați form și finalizați.', true);
    });
    document.getElementById('modalHlsValidate').addEventListener('click', () => {
      const url = document.getElementById('modalHlsUrl').value.trim();
      if (!url) { setModalStatus('Introduceți URL HLS.', false); return; }
      modalSrc = url;
      setModalStatus('URL salvat. Validați form și finalizați.', true);
    });

    document.getElementById('modalPdfUpload').addEventListener('click', () => {
      const input = document.getElementById('modalPdfFile');
      if (!input.files.length) { setModalStatus('Selectați un PDF.', false); return; }
      const fd = new FormData();
      fd.append('file', input.files[0]);
      setModalStatus('Se încarcă...', true);
      fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload-document', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.path) { modalDocPath = data.path; modalDocConverted = false; setModalStatus('PDF încărcat. Setați range și apăsați Convert.', true); }
          else { setModalStatus(data.error || 'Eroare', false); }
        })
        .catch(() => setModalStatus('Eroare', false));
    });
    document.getElementById('modalPdfConvert').addEventListener('click', async () => {
      if (!modalDocPath) { setModalStatus('Încărcați mai întâi PDF.', false); return; }
      const range = document.getElementById('modalPdfRange').value.trim() || 'all';
      setLoading(true, 'Converting...');
      let res;
      try {
        res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/convert-document', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ src: modalDocPath, range }) });
      } catch (e) { res = { ok: false }; }
      setLoading(false);
      if (res.ok) { modalDocConverted = true; modalConvertCount = res.count; setModalStatus('Convertit ' + res.count + ' pagini. Validați form și finalizați.', true); }
      else { setModalStatus(res.error || 'Convert eșuat', false); }
    });
    document.getElementById('modalWordUpload').addEventListener('click', () => {
      const input = document.getElementById('modalWordFile');
      if (!input.files.length) { setModalStatus('Selectați un fișier Word.', false); return; }
      const fd = new FormData();
      fd.append('file', input.files[0]);
      setModalStatus('Se încarcă...', true);
      fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload-document', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.path) { modalDocPath = data.path; modalDocConverted = false; setModalStatus('Document încărcat. Setați range și apăsați Convert.', true); }
          else { setModalStatus(data.error || 'Eroare', false); }
        })
        .catch(() => setModalStatus('Eroare', false));
    });
    document.getElementById('modalWordConvert').addEventListener('click', async () => {
      if (!modalDocPath) { setModalStatus('Încărcați mai întâi documentul.', false); return; }
      const range = document.getElementById('modalWordRange').value.trim() || 'all';
      setLoading(true, 'Converting...');
      let res;
      try {
        res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/convert-document', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ src: modalDocPath, range }) });
      } catch (e) { res = { ok: false }; }
      setLoading(false);
      if (res.ok) { modalDocConverted = true; modalConvertCount = res.count; setModalStatus('Convertit ' + res.count + ' pagini. Validați form și finalizați.', true); }
      else { setModalStatus(res.error || 'Convert eșuat', false); }
    });
    document.getElementById('modalPptxUpload').addEventListener('click', () => {
      const input = document.getElementById('modalPptxFile');
      if (!input.files.length) { setModalStatus('Selectați un fișier PPT/PPTX.', false); return; }
      const fd = new FormData();
      fd.append('file', input.files[0]);
      setModalStatus('Se încarcă...', true);
      fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload-document', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.path) { modalDocPath = data.path; modalDocConverted = false; setModalStatus('PPT încărcat. Setați range și apăsați Convert.', true); }
          else { setModalStatus(data.error || 'Eroare', false); }
        })
        .catch(() => setModalStatus('Eroare', false));
    });
    document.getElementById('modalPptxConvert').addEventListener('click', async () => {
      if (!modalDocPath) { setModalStatus('Încărcați mai întâi PPT/PPTX.', false); return; }
      const range = document.getElementById('modalPptxRange').value.trim() || 'all';
      setLoading(true, 'Converting...');
      let res;
      try {
        res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/convert-document', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ src: modalDocPath, range }) });
      } catch (e) { res = { ok: false }; }
      setLoading(false);
      if (res.ok) { modalDocConverted = true; modalConvertCount = res.count; setModalStatus('Convertit ' + res.count + ' pagini. Validați form și finalizați.', true); }
      else { setModalStatus(res.error || 'Convert eșuat', false); }
    });
    document.getElementById('modalExcelUpload').addEventListener('click', () => {
      const input = document.getElementById('modalExcelFile');
      if (!input.files.length) { setModalStatus('Selectați un fișier Excel.', false); return; }
      const fd = new FormData();
      fd.append('file', input.files[0]);
      setModalStatus('Se încarcă...', true);
      fetch('/api/teams/' + encodeURIComponent(selectedTeam) + '/upload-document', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.path) { modalDocPath = data.path; modalDocConverted = false; setModalStatus('Excel încărcat. Setați range și apăsați Convert.', true); }
          else { setModalStatus(data.error || 'Eroare', false); }
        })
        .catch(() => setModalStatus('Eroare', false));
    });
    document.getElementById('modalExcelConvert').addEventListener('click', async () => {
      if (!modalDocPath) { setModalStatus('Încărcați mai întâi Excel.', false); return; }
      const range = document.getElementById('modalExcelRange').value.trim() || 'all';
      setLoading(true, 'Converting...');
      let res;
      try {
        res = await api('/api/teams/' + encodeURIComponent(selectedTeam) + '/convert-document', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ src: modalDocPath, range }) });
      } catch (e) { res = { ok: false }; }
      setLoading(false);
      if (res.ok) { modalDocConverted = true; modalConvertCount = res.count; setModalStatus('Convertit ' + res.count + ' pagini. Validați form și finalizați.', true); }
      else { setModalStatus(res.error || 'Convert eșuat', false); }
    });

    document.getElementById('modalValidateBtn').addEventListener('click', () => {
      const type = document.getElementById('modalType').value;
      let ok = false;
      if (type === 'image') {
        const dur = parseInt(document.getElementById('modalDuration').value, 10) || 60;
        ok = !!modalSrc && dur >= 1;
        if (ok) setModalStatus('Form valid. Apăsați Finalizare.', true);
        else setModalStatus('Adăugați imagine (upload sau URL valid) și durată.', false);
      } else if (type === 'video') {
        const dur = parseInt(document.getElementById('modalDurationV').value, 10) || 60;
        ok = !!modalSrc && dur >= 1;
        if (ok) setModalStatus('Form valid. Apăsați Finalizare.', true);
        else setModalStatus('Adăugați video (upload sau URL valid) și durată.', false);
      } else if (type === 'web_url') {
        const dur = parseInt(document.getElementById('modalDurationW').value, 10) || 60;
        ok = (modalWebConverted && !!modalWebPath && dur >= 1) || (!modalWebConverted && !!modalSrc && dur >= 1);
        if (ok) setModalStatus('Form valid. Apăsați Finalizare.', true);
        else setModalStatus('Introduceți URL și validați; sau apăsați Convert, apoi setați durata.', false);
      } else if (type === 'vimeo' || type === 'hls') {
        const durId = type === 'vimeo' ? 'modalDurationVi' : 'modalDurationH';
        const dur = parseInt(document.getElementById(durId).value, 10) || 60;
        ok = !!modalSrc && dur >= 1;
        if (ok) setModalStatus('Form valid. Apăsați Finalizare.', true);
        else setModalStatus('Completați URL și durată, apoi validați URL.', false);
      } else if (type === 'pdf' || type === 'word' || type === 'pptx' || type === 'excel') {
        const durId = type === 'pdf' ? 'modalDurationPdf' : type === 'word' ? 'modalDurationWord' : type === 'pptx' ? 'modalDurationPptx' : 'modalDurationExcel';
        const dur = parseInt(document.getElementById(durId).value, 10) || 60;
        ok = modalDocConverted && !!modalDocPath && dur >= 1;
        if (ok) setModalStatus('Form valid. Apăsați Finalizare.', true);
        else setModalStatus('Efectuați Convert înainte, apoi setați durata.', false);
      }
      setModalValid(ok);
    });

    document.getElementById('modalFinalizeBtn').addEventListener('click', () => {
      if (!modalFormValid || !selectedTeam) return;
      const type = document.getElementById('modalType').value;
      let slide = { id: 'slide-' + Date.now(), type, duration: 60, title: '', subtitle: '', enabled: true };
      if (type === 'image') {
        slide.src = modalSrc;
        slide.duration = parseInt(document.getElementById('modalDuration').value, 10) || 60;
        slide.fillWidth = document.getElementById('modalImageFillWidth').checked;
        slide.title = document.getElementById('modalTitle').value.trim();
        slide.subtitle = document.getElementById('modalSubtitle').value.trim();
        slide.enabled = document.getElementById('modalEnabled').value === '1';
      } else if (type === 'video') {
        slide.src = modalSrc;
        slide.duration = parseInt(document.getElementById('modalDurationV').value, 10) || 60;
        slide.videoSound = document.getElementById('modalVideoSound').checked;
        slide.title = document.getElementById('modalTitleV').value.trim();
        slide.subtitle = document.getElementById('modalSubtitleV').value.trim();
        slide.enabled = document.getElementById('modalEnabledV').value === '1';
      } else if (type === 'web_url') {
        slide.duration = parseInt(document.getElementById('modalDurationW').value, 10) || 60;
        slide.title = document.getElementById('modalTitleW').value.trim();
        slide.subtitle = document.getElementById('modalSubtitleW').value.trim();
        slide.enabled = document.getElementById('modalEnabledW').value === '1';
        if (modalWebConverted && modalWebPath) {
          slide.src = modalWebPath;
          slide.converted = true;
          slide.range = document.getElementById('modalWebRange').value.trim() || 'all';
          if (modalConvertCount != null) slide.pageCount = modalConvertCount;
          slide.fillWidth = document.getElementById('modalWebFillWidth').checked;
        } else {
          slide.src = modalSrc;
        }
      } else if (type === 'vimeo') {
        slide.src = modalSrc;
        slide.duration = parseInt(document.getElementById('modalDurationVi').value, 10) || 60;
        slide.vimeoSound = document.getElementById('modalVimeoSound').checked;
        slide.title = document.getElementById('modalTitleVi').value.trim();
        slide.subtitle = document.getElementById('modalSubtitleVi').value.trim();
        slide.enabled = document.getElementById('modalEnabledVi').value === '1';
      } else if (type === 'hls') {
        slide.src = modalSrc;
        slide.duration = parseInt(document.getElementById('modalDurationH').value, 10) || 60;
        slide.title = document.getElementById('modalTitleH').value.trim();
        slide.subtitle = document.getElementById('modalSubtitleH').value.trim();
        slide.enabled = document.getElementById('modalEnabledH').value === '1';
      } else if (type === 'pdf' || type === 'word' || type === 'pptx' || type === 'excel') {
        const rangeId = type === 'pdf' ? 'modalPdfRange' : type === 'word' ? 'modalWordRange' : type === 'pptx' ? 'modalPptxRange' : 'modalExcelRange';
        const durId = type === 'pdf' ? 'modalDurationPdf' : type === 'word' ? 'modalDurationWord' : type === 'pptx' ? 'modalDurationPptx' : 'modalDurationExcel';
        const fillId = type === 'pdf' ? 'modalPdfFillWidth' : type === 'word' ? 'modalWordFillWidth' : type === 'pptx' ? 'modalPptxFillWidth' : 'modalExcelFillWidth';
        const titleId = type === 'pdf' ? 'modalTitlePdf' : type === 'word' ? 'modalTitleWord' : type === 'pptx' ? 'modalTitlePptx' : 'modalTitleExcel';
        const subtitleId = type === 'pdf' ? 'modalSubtitlePdf' : type === 'word' ? 'modalSubtitleWord' : type === 'pptx' ? 'modalSubtitlePptx' : 'modalSubtitleExcel';
        const enabledId = type === 'pdf' ? 'modalEnabledPdf' : type === 'word' ? 'modalEnabledWord' : type === 'pptx' ? 'modalEnabledPptx' : 'modalEnabledExcel';
        slide.src = modalDocPath;
        slide.range = document.getElementById(rangeId).value.trim() || 'all';
        slide.duration = parseInt(document.getElementById(durId).value, 10) || 60;
        slide.fillWidth = document.getElementById(fillId).checked;
        slide.title = document.getElementById(titleId).value.trim();
        slide.subtitle = document.getElementById(subtitleId).value.trim();
        slide.enabled = document.getElementById(enabledId).value === '1';
        slide.converted = true;
        if (modalConvertCount != null) slide.pageCount = modalConvertCount;
      }
      slides.push(slide);
      savePlaylistSilent();
      setChangeStatus('saved_unpushed');
      closeAddSlideModal();
      renderSlides();
      showMsg('Slide adăugat. Push changes for modifications to take effect.', true);
    });

    (async function init() {
      renderSectionCards();
      if (localStorage.getItem(GIT_CACHE_KEY) === 'true') {
        const res = await api('/api/git/commit');
        if (res.ok && res.commit) {
          savedCommit = res.commit;
          try { localStorage.setItem(GIT_COMMIT_KEY, savedCommit); } catch (e) {}
        }
        setGitConnected(true);
      }
      const teams = await loadTeams();
      if (teams && teams.length > 0 && !selectedTeam) {
        loadPlaylist(teams[0]);
      }
    })();
  </script>
</body>
</html>
